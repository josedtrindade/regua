<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√©gua 3.0 - An√°lise de Dupla Camada com OpenAI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .header{text-align:center;color:white;margin-bottom:30px}
    .header h1{font-size:2.5rem;margin-bottom:10px}
    .header p{font-size:1.2rem;opacity:.9}
    .tabs{display:flex;background:white;border-radius:10px;margin-bottom:20px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .tab{flex:1;padding:15px 20px;background:#f8f9fa;border:none;cursor:pointer;font-size:1rem;font-weight:600;transition:all .3s}
    .tab.active{background:#667eea;color:#fff}
    .tab:hover{background:#5a6fd8;color:#fff}
    .content{background:#fff;border-radius:10px;padding:30px;box-shadow:0 4px 15px rgba(0,0,0,.1);min-height:500px}
    .tab-content{display:none}.tab-content.active{display:block}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:10px;text-align:center}
    .stat-card h3{font-size:2rem;margin-bottom:5px}.stat-card p{opacity:.9}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:5px;font-weight:600;color:#333}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:8px;font-size:1rem;transition:border-color .3s}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
    .btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:12px 30px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:transform .2s}
    .btn:hover{transform:translateY(-2px)}.btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-outline{background:transparent;border:2px solid #667eea;color:#667eea}
    .btn-outline:hover{background:#667eea;color:#fff}
    .url-inputs{display:grid;gap:15px;margin-bottom:20px}
    .confidence-indicator{padding:10px;border-radius:8px;margin:10px 0;font-weight:600;text-align:center}
    .verde-escuro{background:#1e7e34;color:#fff}.verde-claro{background:#28a745;color:#fff}.amarelo{background:#ffc107;color:#333}.laranja{background:#fd7e14;color:#fff}.vermelho{background:#dc3545;color:#fff}
    .loading{text-align:center;padding:20px}.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .chart-container{position:relative;height:400px;margin:20px 0}
    .table-container{overflow-x:auto;margin-top:20px}
    table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:600}tr:hover{background:#f8f9fa}
    .success{background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin:10px 0}
    .error{background:#f8d7da;color:#721c24;padding:15px;border-radius:8px;margin:10px 0}
    .connection-status{padding:10px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}
    .connected{background:#d4edda;color:#155724}.disconnected{background:#f8d7da;color:#721c24}
    .ai-status{display:flex;gap:10px;margin-bottom:20px}.ai-indicator{flex:1;padding:8px;border-radius:6px;text-align:center;font-size:.9rem;font-weight:600}.ai-active{background:#d4edda;color:#155724}.ai-inactive{background:#f8d7da;color:#721c24}
    .analysis-steps{background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0}
    .step{display:flex;align-items:center;margin:8px 0;padding:5px}.step-icon{width:20px;height:20px;border-radius:50%;margin-right:10px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
    .step-pending{background:#6c757d;color:#fff}.step-active{background:#007bff;color:#fff}.step-complete{background:#28a745;color:#fff}.step-error{background:#dc3545;color:#fff}
    .security-badge{background:#28a745;color:#fff;padding:5px 10px;border-radius:15px;font-size:.8rem;margin-left:10px}
    .analysis-section{background:#f8f9fa;padding:20px;border-radius:8px;margin:15px 0;border-left:4px solid #667eea}
    .layer-analysis{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0}
    .team-analysis{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .criteria-table{width:100%;margin-top:10px}.criteria-table th,.criteria-table td{padding:8px;text-align:center;border:1px solid #ddd}
    .score-high{background:#d4edda;color:#155724}.score-medium{background:#fff3cd;color:#856404}.score-low{background:#f8d7da;color:#721c24}
    .recommendations-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
    .recommendation-card{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1);text-align:center}
    .recommendation-card h4{color:#667eea;margin-bottom:10px}
    .collapsible{background:#f1f1f1;color:#444;cursor:pointer;padding:15px;width:100%;border:none;text-align:left;outline:none;font-size:15px;font-weight:600;border-radius:5px;margin:5px 0}
    .collapsible:hover{background:#ddd}.collapsible.active{background:#667eea;color:#fff}
    .collapsible-content{padding:0 15px;max-height:0;overflow:hidden;transition:max-height .2s ease-out;background:#fff;border-radius:0 0 5px 5px}
    .collapsible-content.active{padding:15px;max-height:1000px}

    /* ====== LANDING PAGE ====== */
    #landing{max-width:1200px;margin:0 auto;padding:40px 20px;color:#fff}
    .landing-hero{text-align:center;margin-bottom:60px}
    .landing-hero h1{font-size:3rem;margin-bottom:20px;font-weight:700}
    .landing-hero p{font-size:1.3rem;margin-bottom:30px;opacity:.9}
    .cta-buttons{display:flex;gap:20px;justify-content:center;margin-bottom:40px;flex-wrap:wrap}
    .badges{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
    .badges span{background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;font-size:.9rem}
    .features-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px}
    .feature-card{background:rgba(255,255,255,.1);padding:30px;border-radius:15px;text-align:center;backdrop-filter:blur(10px)}
    .feature-card h3{font-size:1.5rem;margin-bottom:15px;color:#fff}
    .feature-card p{opacity:.9;line-height:1.6}

    /* ====== BLOCO DE LOGIN ====== */
    #auth{max-width:480px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.12);padding:20px}
    #auth h2{margin-bottom:10px}
    #status{color:#fff;text-align:center;margin:10px auto}
    .topbar{display:none;justify-content:space-between;align-items:center;max-width:1400px;margin:0 auto;padding:10px 20px;color:#fff}
    .topbar .right{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>

  <!-- Status + Topbar (aparece quando logado) -->
  <div id="status">Carregando‚Ä¶</div>
  <div class="topbar" id="topbar">
    <div><strong>R√©gua 3.0</strong></div>
    <div class="right">
      <span id="whoami"></span>
      <button class="btn" id="btn-logout" style="padding:8px 14px">Sair</button>
    </div>
  </div>

  <!-- LANDING (vis√≠vel quando N√ÉO logado) -->
  <section id="landing" style="display:none">
    <div class="landing-hero">
      <h1>R√©gua 3.0 ‚Äì An√°lises profissionais para apostar com m√©todo</h1>
      <p>Metodologia de Dupla Camada com 12 diretrizes. Leia o jogo como um analista ‚Äî sem achismo.</p>
      <div class="cta-buttons">
        <button class="btn" onclick="showLogin()">Come√ßar agora</button>
        <a class="btn btn-outline" href="#metodologia">Ver metodologia</a>
      </div>
      <div class="badges">
        <span>‚úîÔ∏è Dupla Camada</span>
        <span>‚úîÔ∏è Regras de Zebra e Volatilidade</span>
        <span>‚úîÔ∏è Recomenda√ß√µes por mercado</span>
      </div>
    </div>

    <div class="features-grid">
      <div class="feature-card">
        <h3>üìä Camada 1 ‚Äì Circunstancial</h3>
        <p>9 crit√©rios (motiva√ß√£o, desfalques, psicol√≥gico, log√≠stica...) com justificativas.</p>
      </div>
      <div class="feature-card">
        <h3>üèóÔ∏è Camada 2 ‚Äì Estrutural</h3>
        <p>4 crit√©rios ponderados (elenco, padr√£o t√°tico, resili√™ncia, t√©cnico/gest√£o).</p>
      </div>
      <div class="feature-card">
        <h3>üéØ Veredito + Cores</h3>
        <p>Classifica√ß√£o Verde/Vermelho com % de confian√ßa e recomenda√ß√µes (1X, X2, 12, Triplo).</p>
      </div>
    </div>
  </section>

  <!-- BLOCO DE LOGIN (vis√≠vel quando N√ÉO logado) -->
  <div id="auth" style="display:none">
    <h2>Entrar ou Criar Conta</h2>
    <div class="form-group">
      <label for="email">E-mail</label>
      <input id="email" type="email" placeholder="voce@email.com"/>
    </div>
    <div class="form-group">
      <label for="password">Senha</label>
      <input id="password" type="password" placeholder="Sua senha"/>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btn-login">Entrar</button>
      <button class="btn" id="btn-signup" type="button">Criar conta</button>
      <button class="btn" id="btn-forgot" type="button">Esqueci a senha</button>
    </div>
    <p style="margin-top:10px;color:#555;font-size:.9rem">
      * Voc√™ receber√° um e-mail de confirma√ß√£o ao criar a conta e, se precisar, um link para redefinir a senha.
    </p>
  </div>

  <!-- TODO O SEU APP FICA AQUI DENTRO (vis√≠vel quando logado) -->
  <div id="app" style="display:none">
    <div class="container">
      <div class="header">
        <h1>‚öΩ R√©gua 3.0 - An√°lise de Dupla Camada</h1>
        <p>Sistema Inteligente de An√°lise de Futebol com Metodologia Completa <span class="security-badge">üîí SEGURO</span></p>
      </div>

      <div id="connectionStatus" class="connection-status disconnected">üîÑ Conectando ao banco de dados...</div>

      <div class="ai-status">
        <div id="openaiStatus" class="ai-indicator ai-active">üß† OpenAI GPT-4: Ativo e Seguro</div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard', event)">üìä Dashboard</button>
        <button class="tab" onclick="showTab('nova-analise', event)">‚ûï Nova An√°lise</button>
        <button class="tab" onclick="showTab('historico', event)">üìã Hist√≥rico</button>
        <button class="tab" onclick="showTab('metodologia', event)">üìö Metodologia</button>
        <button class="tab" onclick="showTab('sobre', event)">‚ÑπÔ∏è Sobre</button>
      </div>

      <div class="content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
          <h2>üìä Performance da R√©gua 3.0</h2>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><h3 id="totalJogos">-</h3><p>Total de Jogos</p></div>
            <div class="stat-card"><h3 id="taxaAcerto">-</h3><p>Taxa de Acerto Geral</p></div>
            <div class="stat-card"><h3 id="verdeEscuroAcerto">-</h3><p>Verde Escuro</p></div>
            <div class="stat-card"><h3 id="verdeClaroAcerto">-</h3><p>Verde Claro</p></div>
            <div class="stat-card"><h3 id="amareloAcerto">-</h3><p>Amarelo</p></div>
            <div class="stat-card"><h3 id="laranjaAcerto">-</h3><p>Laranja</p></div>
          </div>

          <div class="chart-container"><canvas id="performanceChart"></canvas></div>

          <div class="table-container">
            <h3>üéØ √öltimas An√°lises</h3>
            <table id="ultimasAnalises">
              <thead>
              <tr><th>Jogo</th><th>N√≠vel</th><th>Cen√°rio</th><th>Previs√£o</th><th>Resultado</th><th>Acerto</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Nova An√°lise Tab -->
        <div id="nova-analise" class="tab-content">
          <h2>‚ûï Nova An√°lise com R√©gua 3.0</h2>
          <div class="success">
            <h4>üîí Sistema Seguro</h4>
            <p>Sua chave OpenAI est√° protegida no servidor. A an√°lise segue fielmente a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada" com 12 diretrizes espec√≠ficas.</p>
          </div>

          <form id="novaAnaliseForm">
            <div class="form-group">
              <label>üèÜ Jogo (ex: Flamengo x Palmeiras)</label>
              <input type="text" id="jogoInput" placeholder="Time Mandante x Time Visitante" required>
            </div>

            <div class="form-group">
              <label>üèÜ Campeonato</label>
              <input type="text" id="campeonatoInput" placeholder="Ex: Campeonato Brasileiro - S√©rie A" required>
            </div>

            <div class="url-inputs">
              <div class="form-group">
                <label>üì∞ URL Not√≠cia 1 (obrigat√≥ria)</label>
                <input type="url" id="url1" placeholder="https://globoesporte.globo.com/..." required>
              </div>
              <div class="form-group">
                <label>üì∞ URL Not√≠cia 2 (opcional)</label>
                <input type="url" id="url2" placeholder="https://espn.com.br/...">
              </div>
              <div class="form-group">
                <label>üì∞ URL Not√≠cia 3 (opcional)</label>
                <input type="url" id="url3" placeholder="https://lance.com.br/...">
              </div>
            </div>

            <button type="submit" class="btn" id="analisarBtn">üß† Analisar com R√©gua 3.0</button>
          </form>

          <div id="analysisSteps" class="analysis-steps" style="display:none">
            <h4>üîÑ Progresso da An√°lise:</h4>
            <div class="step" id="step1"><div class="step-icon step-pending">1</div><span>Coletando dados das URLs...</span></div>
            <div class="step" id="step2"><div class="step-icon step-pending">2</div><span>Aplicando as 12 diretrizes de pondera√ß√£o...</span></div>
            <div class="step" id="step3"><div class="step-icon step-pending">3</div><span>Executando Camada 1 (9 crit√©rios circunstanciais)...</span></div>
            <div class="step" id="step4"><div class="step-icon step-pending">4</div><span>Executando Camada 2 (4 crit√©rios estruturais)...</span></div>
            <div class="step" id="step5"><div class="step-icon step-pending">5</div><span>Gerando veredito final e recomenda√ß√µes...</span></div>
            <div class="step" id="step6"><div class="step-icon step-pending">6</div><span>Salvando an√°lise completa...</span></div>
          </div>

          <div id="resultadoAnalise" style="margin-top:30px;"></div>
        </div>

        <!-- Hist√≥rico Tab -->
        <div id="historico" class="tab-content">
          <h2>üìã Hist√≥rico Completo</h2>
          <div class="form-group">
            <label>üîç Filtrar por N√≠vel</label>
            <select id="filtroNivel" onchange="filtrarHistorico()">
              <option value="">Todos os n√≠veis</option>
              <option value="Verde Escuro">Verde Escuro (90-100%)</option>
              <option value="Verde Claro">Verde Claro (80-89%)</option>
              <option value="Amarelo">Amarelo (70-79%)</option>
              <option value="Laranja">Laranja (60-69%)</option>
              <option value="Vermelho">Vermelho (&lt;60%)</option>
            </select>
          </div>

          <div class="table-container">
            <table id="historicoCompleto">
              <thead>
              <tr>
                <th>Jogo</th><th>Campeonato</th><th>N√≠vel</th><th>Cen√°rio</th>
                <th>Confian√ßa %</th><th>Previs√£o</th><th>Resultado</th><th>Acerto</th><th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Metodologia Tab -->
        <div id="metodologia" class="tab-content">
          <!-- (seu conte√∫do original da metodologia permanece igual) -->
          <!-- ... -->
        </div>

        <!-- Sobre Tab -->
        <div id="sobre" class="tab-content">
          <!-- (seu conte√∫do original do "Sobre" permanece igual) -->
          <!-- ... -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG DO SUPABASE (seu projeto) =====
    const SUPABASE_URL = 'https://shjjweviipblcjukvxry.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNoamp3ZXZpaXBibGNqdWt2eHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjY1NDMsImV4cCI6MjA3MjQ0MjU0M30.LJmmMKDASQfvDo4D_S-tbHDUh2jUb2VuFwl3EqrLBas';

    let supabase = null;

    // ======= BOOT =======
    document.addEventListener('DOMContentLoaded', async () => {
      inicializarSupabase();              // cria o client
      configurarAutenticacao();           // listeners de auth
      await refreshUI();                  // mostra login ou app
      if (await isLogged()) {             // s√≥ carrega dados se logado
        carregarDashboard();
      }
      inicializarCollapsibles();
    });

    // ======= SUPABASE CLIENT =======
    function inicializarSupabase() {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        setConnStatus(true);
      } catch (error) {
        console.error('Erro ao conectar:', error);
        setConnStatus(false);
      }
    }

    function setConnStatus(ok){
      const el = document.getElementById('connectionStatus');
      if(!el) return;
      el.innerHTML = ok ? '‚úÖ Conectado ao banco de dados' : '‚ùå Erro na conex√£o com banco';
      el.className = 'connection-status ' + (ok ? 'connected' : 'disconnected');
    }

    // ======= AUTH UI =======
    async function isLogged(){
      const { data:{ session } } = await supabase.auth.getSession();
      return !!session;
    }

    async function refreshUI(){
      const logged = await isLogged();
      const { data:{ session } } = await supabase.auth.getSession();

      const statusEl = document.getElementById('status');
      const authEl   = document.getElementById('auth');
      const appEl    = document.getElementById('app');
      const topbar   = document.getElementById('topbar');
      const whoami   = document.getElementById('whoami');
      const landingEl = document.getElementById('landing');

      if (logged) {
        authEl.style.display = 'none';
        landingEl.style.display = 'none';
        appEl.style.display  = 'block';
        topbar.style.display = 'flex';
        statusEl.textContent = 'Logado';
        if (whoami && session?.user?.email) whoami.textContent = session.user.email;
      } else {
        appEl.style.display  = 'none';
        topbar.style.display = 'none';
        authEl.style.display = 'none';
        landingEl.style.display = 'block';
        statusEl.textContent = 'N√£o logado';
      }
    }

    // ======= FUN√á√ÉO PARA MOSTRAR LOGIN =======
    function showLogin() {
      document.getElementById('landing').style.display = 'none';
      document.getElementById('auth').style.display = 'block';
    }

    function configurarAutenticacao(){
      // reage a login/logout/refresh
      supabase.auth.onAuthStateChange(async (_event,_session)=> {
        await refreshUI();
        if (await isLogged()) carregarDashboard();
      });

      // A√ß√µes dos bot√µes
      document.getElementById('btn-signup').onclick = async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const { error } = await supabase.auth.signUp({ email, password });
        alert(error ? error.message : 'Cadastro criado! Confirme seu e-mail para ativar a conta.');
      };

      document.getElementById('btn-login').onclick = async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) alert(error.message);
      };

      document.getElementById('btn-forgot').onclick = async () => {
        const email = document.getElementById('email').value.trim();
        if (!email) { alert('Digite seu e-mail antes.'); return; }
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: 'https://regua.netlify.app/reset' });
        alert(error ? error.message : 'Enviamos um e-mail com o link para redefinir sua senha.');
      };

      document.getElementById('btn-logout').onclick = async () => {
        await supabase.auth.signOut();
      };
    }

    // ======= COLLAPSIBLES =======
    function inicializarCollapsibles() {
      const collapsibles = document.querySelectorAll('.collapsible');
      collapsibles.forEach(collapsible => {
        collapsible.addEventListener('click', function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          content.classList.toggle('active');
        });
      });
    }

    // ======= TABS (ajuste: recebendo o event) =======
    function showTab(tabName, ev) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      if (ev && ev.target) ev.target.classList.add('active');

      if (tabName === 'dashboard')      carregarDashboard();
      else if (tabName === 'historico') carregarHistorico();
    }

    // ======= DASHBOARD / HIST√ìRICO =======
    async function carregarDashboard() {
      try {
        const { data: analises, error } = await supabase
          .from('analises_regua3')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) { console.error('Erro ao buscar an√°lises:', error); return; }

        const stats = calcularEstatisticas(analises || []);
        atualizarDashboard(stats);
        criarGrafico(stats);
        const ultimasAnalises = (analises || []).slice(0, 10);
        atualizarTabelaUltimas(ultimasAnalises);
      } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
      }
    }

    function calcularEstatisticas(analises) {
      const stats = {
        total: analises.length, acertos: 0,
        verdeEscuro:{total:0,acertos:0}, verdeClaro:{total:0,acertos:0},
        amarelo:{total:0,acertos:0}, laranja:{total:0,acertos:0}, vermelho:{total:0,acertos:0}
      };
      analises.forEach(a=>{
        const acertou = a.acerto && (a.acerto.includes('‚úÖ') || a.acerto.includes('Pleno'));
        if (acertou) stats.acertos++;
        const nivel = a.nivel_confianca || '';
        if (nivel.includes('Verde Escuro')) {stats.verdeEscuro.total++; if (acertou) stats.verdeEscuro.acertos++;}
        else if (nivel.includes('Verde Claro')) {stats.verdeClaro.total++; if (acertou) stats.verdeClaro.acertos++;}
        else if (nivel.includes('Amarelo')) {stats.amarelo.total++; if (acertou) stats.amarelo.acertos++;}
        else if (nivel.includes('Laranja')) {stats.laranja.total++; if (acertou) stats.laranja.acertos++;}
        else if (nivel.includes('Vermelho')) {stats.vermelho.total++; if (acertou) stats.vermelho.acertos++;}
      });
      return stats;
    }

    function atualizarDashboard(stats){
      document.getElementById('totalJogos').textContent = stats.total;
      document.getElementById('taxaAcerto').textContent =
        stats.total>0 ? Math.round((stats.acertos/stats.total)*100)+'%' : '0%';
      document.getElementById('verdeEscuroAcerto').textContent =
        stats.verdeEscuro.total>0 ? Math.round((stats.verdeEscuro.acertos/stats.verdeEscuro.total)*100)+'%' : '0%';
      document.getElementById('verdeClaroAcerto').textContent =
        stats.verdeClaro.total>0 ? Math.round((stats.verdeClaro.acertos/stats.verdeClaro.total)*100)+'%' : '0%';
      document.getElementById('amareloAcerto').textContent =
        stats.amarelo.total>0 ? Math.round((stats.amarelo.acertos/stats.amarelo.total)*100)+'%' : '0%';
      document.getElementById('laranjaAcerto').textContent =
        stats.laranja.total>0 ? Math.round((stats.laranja.acertos/stats.laranja.total)*100)+'%' : '0%';
    }

    function criarGrafico(stats){
      const ctx = document.getElementById('performanceChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type:'bar',
        data:{
          labels:['Verde Escuro','Verde Claro','Amarelo','Laranja','Vermelho'],
          datasets:[{label:'Taxa de Acerto (%)',data:[
            stats.verdeEscuro.total?Math.round((stats.verdeEscuro.acertos/stats.verdeEscuro.total)*100):0,
            stats.verdeClaro.total?Math.round((stats.verdeClaro.acertos/stats.verdeClaro.total)*100):0,
            stats.amarelo.total?Math.round((stats.amarelo.acertos/stats.amarelo.total)*100):0,
            stats.laranja.total?Math.round((stats.laranja.acertos/stats.laranja.total)*100):0,
            stats.vermelho.total?Math.round((stats.vermelho.acertos/stats.vermelho.total)*100):0
          ], backgroundColor:['#1e7e34','#28a745','#ffc107','#fd7e14','#dc3545']}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}
      });
    }

    function atualizarTabelaUltimas(analises){
      const tbody = document.querySelector('#ultimasAnalises tbody'); tbody.innerHTML='';
      analises.forEach(analise=>{
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${analise.jogo||'-'}</td>
          <td><span class="confidence-indicator ${getClasseNivel(analise.nivel_confianca||'')}">${analise.nivel_confianca||'-'}</span></td>
          <td>${analise.cenario_classificacao||'-'}</td>
          <td>${analise.previsao_regua||'-'}</td>
          <td>${analise.resultado_real||'-'}</td>
          <td>${analise.acerto||'-'}</td>`;
      });
    }

    function getClasseNivel(nivel){
      if (nivel.includes('Verde Escuro')) return 'verde-escuro';
      if (nivel.includes('Verde Claro')) return 'verde-claro';
      if (nivel.includes('Amarelo')) return 'amarelo';
      if (nivel.includes('Laranja')) return 'laranja';
      if (nivel.includes('Vermelho')) return 'vermelho';
      return '';
    }

    // ======= NOVA AN√ÅLISE (mantive seu fluxo) =======
    document.addEventListener('DOMContentLoaded', ()=>{
      const form = document.getElementById('novaAnaliseForm');
      if (!form) return;
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!supabase){ alert('‚ùå Erro na conex√£o com banco de dados!'); return; }

        const jogo = document.getElementById('jogoInput').value;
        const campeonato = document.getElementById('campeonatoInput').value;
        const urls = [document.getElementById('url1').value, document.getElementById('url2').value, document.getElementById('url3').value].filter(u=>u.trim());
        if (urls.length===0){ alert('‚ùå Adicione pelo menos uma URL de not√≠cia!'); return; }

        document.getElementById('analysisSteps').style.display='block';
        document.getElementById('resultadoAnalise').innerHTML='';
        document.getElementById('analisarBtn').disabled=true;

        try {
          await analisarComRegua3(jogo, campeonato, urls);
        } catch (err) {
          console.error('Erro na an√°lise:', err);
          document.getElementById('resultadoAnalise').innerHTML =
            `<div class="error"><h3>‚ùå Erro na An√°lise</h3><p>${err.message}</p><p><small>Verifique se a chave OpenAI est√° configurada corretamente.</small></p></div>`;
        } finally {
          document.getElementById('analisarBtn').disabled=false;
        }
      });
    });

    async function analisarComRegua3(jogo, campeonato, urls){
      updateStep('step1','active');
      const conteudos = await extrairConteudoURLs(urls);
      updateStep('step1','complete');

      updateStep('step2','active'); await delay(1000); updateStep('step2','complete');
      updateStep('step3','active'); await delay(1000); updateStep('step3','complete');
      updateStep('step4','active'); await delay(1000); updateStep('step4','complete');

      updateStep('step5','active');
      const analiseCompleta = await analisarConteudoComRegua3(jogo, campeonato, conteudos, urls);
      updateStep('step5','complete');

      updateStep('step6','active'); await salvarAnaliseNoBanco(analiseCompleta); updateStep('step6','complete');

      mostrarResultadoAnalise(analiseCompleta);
      carregarDashboard();
    }

    function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function updateStep(stepId,status){
      const step = document.getElementById(stepId); if(!step) return;
      const icon = step.querySelector('.step-icon');
      icon.className = `step-icon step-${status}`;
      if (status==='complete') icon.innerHTML='‚úì';
      else if (status==='error') icon.innerHTML='‚úó';
    }

    async function extrairConteudoURLs(urls){
      const conteudos=[];
      for (const url of urls){
        try{
          const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
          const data = await response.json();
          const parser = new DOMParser();
          const doc = parser.parseFromString(data.contents,'text/html');
          const texto = doc.body.innerText.substring(0,3000);
          conteudos.push({ url, conteudo:texto });
        }catch(e){
          console.error(`Erro ao extrair ${url}:`, e);
          conteudos.push({ url, conteudo:'Erro ao extrair conte√∫do' });
        }
      }
      return conteudos;
    }

    async function analisarConteudoComRegua3(jogo, campeonato, conteudos, urls){
      const promptCompleto = `Voc√™ √© um Analista de Futebol S√™nior, aut√¥nomo e proativo. Sua tarefa √© realizar uma an√°lise completa de uma partida de futebol usando a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada".

DADOS DA PARTIDA:
Campeonato: ${campeonato}
Partida: ${jogo}

DIRETRIZES DE AN√ÅLISE AVAN√áADA (REGRAS DE PONDERA√á√ÉO):
Antes de iniciar a avalia√ß√£o, voc√™ deve aplicar as seguintes diretrizes de pondera√ß√£o para cen√°rios espec√≠ficos do futebol brasileiro ou internacional. Elas se sobrep√µem √† avalia√ß√£o padr√£o para garantir uma an√°lise mais precisa e sutil.

Diretriz 1: "Regra do Desgaste Log√≠stico" (An√°logo √† Vantagem Extrema)
Cen√°rio: Se uma equipe (especialmente a visitante) jogou uma partida decisiva de mata-mata no meio da semana, envolvendo uma viagem longa.
A√ß√£o: Travar J (Log√≠stica/Fadiga) em ‚â§ 3/10 para essa equipe, considerar time misto/reserva em C (Desfalques) e explicitar baixa intensidade que aumenta chance de resultado surpreendente.

Diretriz 2: "Regra do Cl√°ssico de Desespero" (An√°logo ao Equil√≠brio T√°tico do 0x0)
Cen√°rio: Cl√°ssico regional com um time no topo (t√≠tulo/G4) vs. outro no Z4.
A√ß√£o: B (Motiva√ß√£o) do desesperado = 10/10; D (Psicol√≥gico) do favorito com risco de complac√™ncia/press√£o; reconhecer neutraliza√ß√£o parcial da diferen√ßa t√©cnica.

Diretriz 3: "Regra do Fator Clim√°tico/Campo" (An√°logo da Altitude)
Cen√°rio: Calor extremo/gramado pesado.
A√ß√£o: Potencializar F (Mando de Campo) do mandante; em G (Elenco/Estrat√©gia) reduzir peso da superioridade t√©cnica do visitante se for time de toque de bola; jogo tende a ser mais f√≠sico.

Diretriz 4: "Regra do Le√£o Ferido" (Revers√£o √† m√©dia local)
Cen√°rio: Time qualificado em 3+ jogos sem vencer, jogando em casa contra advers√°rio em boa fase (similar/um pouco inferior).
A√ß√£o: F (Mando) ‚â• 9; reduzir peso de H (Forma) do advers√°rio; tend√™ncia de jogo mais agressivo ‚Üí tend√™ncia a Over 2.5.

Diretriz 5: "Alerta de Zebra por Calamidade"
Cen√°rio: Mandante com 5+ desfalques importantes e visitante sem press√£o.
A√ß√£o: Classificar como "Risco Imponder√°vel"; evitar palpite seco; na Loteca sugerir Triplo (1X2); explicitar que a l√≥gica aponta visitante, mas cen√°rio de supera√ß√£o equaliza.

Diretriz 6: "Ressaca Heroica"
Cen√°rio: Time vem de grande feito na semana (classifica√ß√£o/t√≠tulo/cl√°ssico) e enfrenta advers√°rio teoricamente mais fraco, principalmente fora.
A√ß√£o: D (Psicol√≥gico) moderado (6-7/10), classificar como "Risco de Complac√™ncia"; evitar aposta seca; preferir Duplo Aberto (12) ou at√© Triplo.

Diretriz 7: "Revers√£o √† M√©dia (Despertar do Gigante)"
Cen√°rio: Elenco superior (Crit√©rio 1 ‚â• 8) em jejum de 5+ jogos vs. elenco inferior em boa fase.
A√ß√£o: Reduzir peso de H (Forma recente); valorizar Crit√©rio 1 (fator latente); classificar como "Alto Risco de Revers√£o"; evitar aposta seca; Duplo Aberto (12) ou Triplo na Loteca.

Diretriz 8: Times de Meio de Tabela x Mandantes Desesperados
S√©rie B (obrigat√≥rio): Visitante 7¬∫ pra baixo contra mandante no Z4 em casa NUNCA recebe Verde Escuro/Verde Claro ‚Üí no m√≠nimo Amarelo com empate prov√°vel.
S√©rie A: aplica para visitante 8¬∫‚Äì12¬∫; G4/G6 mant√©m leitura normal.
Europa: s√≥ aplicar se houver crise documentada.

Diretriz 9: Empate na Ida
Regra: Se o favorito empatou a ida fora, rebaixe um n√≠vel de cor (VE‚ÜíVC; VC‚ÜíAmarelo), exceto se a ida j√° estava resolvida (3+ gols).

Diretriz 10: O Miolo Perigos√≠ssimo (diferen√ßa 0‚Äì2 pts)
Classifica√ß√£o: Vermelho (<60%) ‚Üí sempre Triplo (1X2). Zona de imprevisibilidade m√°xima; n√£o h√° vi√©s de placar confi√°vel.

Diretriz 11: Alerta de Zebra no Verde Claro
Se VC (80‚Äì89%), checar: (i) favorito goleia ou vence magro? (ii) visitante defende bem? (iii) desfalques ofensivos do favorito?
Se ‚â•2 positivos ‚Üí rebaixar para ~75% (Amarelo). Mudar de aposta seca para Duplo Aberto (12) ou Duplo Fechado (1X).

Diretriz 12: Volatilidade Amarela
No Amarelo (70‚Äì79%), avaliar potencial ofensivo do azar√£o: m√©dia de gols, defesa fr√°gil do favorito fora, artilheiro em fase.
Se ‚â•2 positivos ‚Üí incluir placares el√°sticos e tender a Over 2.5/3.5. Se houver "Ressaca Heroica", baixar D e J.

FLUXO DE TRABALHO OBRIGAT√ìRIO (Coleta pr√©-an√°lise):
‚Ä¢ Posi√ß√£o na tabela e campanha geral.
‚Ä¢ √öltimos 5 jogos de cada equipe.
‚Ä¢ Desfalques confirmados/prov√°veis (les√µes, suspens√µes).
‚Ä¢ Clima interno (crise, euforia, press√£o).
‚Ä¢ Hist√≥rico recente de confrontos diretos.
‚Ä¢ Log√≠stica (sequ√™ncia de jogos e viagens).

METODOLOGIA R√âGUA 3.0 ‚Äî AN√ÅLISE DE DUPLA CAMADA

PASSO 1: CAMADA 1 ‚Äî FOR√áA CIRCUNSTANCIAL (9 crit√©rios, 0‚Äì10)
Avalie e justifique para cada time:
B. Motiva√ß√£o
C. Desfalques
D. Psicol√≥gico
E. Momento na Tabela
F. Mando de Campo
G. Elenco/Estrat√©gia T√°tica (encaixe para este confronto)
H. Forma Recente
I. Confronto Direto
J. Log√≠stica/Fadiga
Em cada time, some um total (0‚Äì90) e apresente um "Sem√°foro do Jogo".

PASSO 2: CAMADA 2 ‚Äî FOR√áA ESTRUTURAL (√çndice Pr√°tico, ponderado)
Para cada time:
1. Qualidade Estrutural do Elenco (Peso 3)
2. Consist√™ncia / Padr√£o T√°tico (Peso 2)
3. Resili√™ncia Mental (Peso 2)
4. Fator T√©cnico/Gerencial (Peso 1)
Apresente "total_ponderado" (0‚Äì80).

PASSO 3: VEREDITO FINAL ‚Äî CONFLITOS e CEN√ÅRIO
Compare Camada 1 x Camada 2 e determine:
‚Ä¢ Vencedor circunstancial
‚Ä¢ Vencedor estrutural
‚Ä¢ Cen√°rio de classifica√ß√£o
‚Ä¢ N√≠vel e % de confian√ßa (faixas):
  üü¢ Verde Escuro (90‚Äì100%) ‚Üí apostar seco / coluna √∫nica
  üü¢ Verde Claro (80‚Äì89%) ‚Üí 1 ou 2, seguran√ßa 1X/2X
  üü° Amarelo (70‚Äì79%) ‚Üí duplo obrigat√≥rio (1X ou X2)
  üü† Laranja (60‚Äì69%) ‚Üí duplo aberto (12) ou Triplo
  üî¥ Vermelho (<60%) ‚Üí Triplo (1X2)
‚Ä¢ Liste quais diretrizes (1‚Äì12) foram aplicadas e como.

RECOMENDA√á√ïES PR√ÅTICAS:
‚Ä¢ Resultado Mais Prov√°vel
‚Ä¢ 2‚Äì3 placares prov√°veis
‚Ä¢ Mercado de Gols (Over/Under) e justificativa
‚Ä¢ Ambos Marcam (BTTS) e justificativa
‚Ä¢ Loteca (Coluna 1, Meio, 2; Duplo/Triplo quando necess√°rio)

CONTE√öDO DAS NOT√çCIAS (base para a coleta):
${conteudos.map(c => `URL: ${c.url}\nConte√∫do: ${c.conteudo}`).join('\n\n')}

Responda OBRIGATORIAMENTE em JSON com esta estrutura:
{
  "coleta_dados": {
    "posicao_tabela": "string",
    "ultimos_jogos": "string",
    "desfalques": "string",
    "clima_interno": "string",
    "historico_confrontos": "string",
    "logistica": "string"
  },
  "camada1_circunstancial": {
    "mandante": {
      "motivacao": {"nota": 0, "justificativa": "string"},
      "desfalques": {"nota": 0, "justificativa": "string"},
      "psicologico": {"nota": 0, "justificativa": "string"},
      "momento_tabela": {"nota": 0, "justificativa": "string"},
      "mando_campo": {"nota": 0, "justificativa": "string"},
      "elenco_estrategia": {"nota": 0, "justificativa": "string"},
      "forma_recente": {"nota": 0, "justificativa": "string"},
      "confronto_direto": {"nota": 0, "justificativa": "string"},
      "logistica_fadiga": {"nota": 0, "justificativa": "string"},
      "total": 0
    },
    "visitante": {
      "motivacao": {"nota": 0, "justificativa": "string"},
      "desfalques": {"nota": 0, "justificativa": "string"},
      "psicologico": {"nota": 0, "justificativa": "string"},
      "momento_tabela": {"nota": 0, "justificativa": "string"},
      "mando_campo": {"nota": 0, "justificativa": "string"},
      "elenco_estrategia": {"nota": 0, "justificativa": "string"},
      "forma_recente": {"nota": 0, "justificativa": "string"},
      "confronto_direto": {"nota": 0, "justificativa": "string"},
      "logistica_fadiga": {"nota": 0, "justificativa": "string"},
      "total": 0
    },
    "semaforo_jogo": "string"
  },
  "camada2_estrutural": {
    "mandante": {
      "qualidade_elenco": {"nota": 0, "peso": 3, "justificativa": "string"},
      "consistencia_tatica": {"nota": 0, "peso": 2, "justificativa": "string"},
      "resiliencia_mental": {"nota": 0, "peso": 2, "justificativa": "string"},
      "fator_gerencial": {"nota": 0, "peso": 1, "justificativa": "string"},
      "total_ponderado": 0
    },
    "visitante": {
      "qualidade_elenco": {"nota": 0, "peso": 3, "justificativa": "string"},
      "consistencia_tatica": {"nota": 0, "peso": 2, "justificativa": "string"},
      "resiliencia_mental": {"nota": 0, "peso": 2, "justificativa": "string"},
      "fator_gerencial": {"nota": 0, "peso": 1, "justificativa": "string"},
      "total_ponderado": 0
    }
  },
  "veredito_final": {
    "vencedor_circunstancial": "string",
    "vencedor_estrutural": "string",
    "cenario_classificacao": "string",
    "nivel_confianca": "string",
    "percentual_confianca": 0,
    "diretrizes_aplicadas": ["string"],
    "analise_final": "string"
  },
  "recomendacoes": {
    "resultado_provavel": "string",
    "placares_provaveis": ["string"],
    "mercado_gols": "string",
    "ambos_marcam": "string",
    "loteca": "string"
  }
}`;

      try{
        const response = await fetch('/.netlify/functions/openai-analysis', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            messages:[
              { role:'system', content:'Voc√™ √© um especialista...' },
              { role:'user', content: promptCompleto }
            ],
            model:'gpt-4', temperature:0, max_tokens:4096
          })
        });
        if (!response.ok) throw new Error('Erro na API: '+response.status);
        const data = await response.json();
        const analiseTexto = data.choices[0].message.content;
        const analiseJSON = JSON.parse(analiseTexto);
        analiseJSON.jogo = jogo; analiseJSON.campeonato = campeonato; analiseJSON.urls = urls; analiseJSON.timestamp = new Date().toISOString();
        return analiseJSON;
      } catch (error){
        console.error('Erro na an√°lise OpenAI:', error);
        // Fallback (mantido igual ao seu)
        return { /* ... seu objeto de fallback igual ao original ... */ };
      }
    }

    async function salvarAnaliseNoBanco(analise){
      const { error } = await supabase.from('analises_regua3').insert([{
        jogo: analise.jogo, campeonato: analise.campeonato, urls: analise.urls,
        coleta_dados: analise.coleta_dados, camada1_circunstancial: analise.camada1_circunstancial,
        camada2_estrutural: analise.camada2_estrutural, veredito_final: analise.veredito_final,
        recomendacoes: analise.recomendacoes, nivel_confianca: analise.veredito_final.nivel_confianca,
        percentual_confianca: analise.veredito_final.percentual_confianca,
        cenario_classificacao: analise.veredito_final.cenario_classificacao,
        previsao_regua: analise.recomendacoes.resultado_provavel, created_at: new Date().toISOString()
      }]);
      if (error) throw error;
    }

    function mostrarResultadoAnalise(analise){
      const resultado = document.getElementById('resultadoAnalise');
      // (mantido: seu HTML de apresenta√ß√£o do resultado)
      // ... cole aqui o mesmo bloco que voc√™ j√° tinha para renderizar o resultado ...
      // Reativar collapsibles:
      inicializarCollapsibles();
    }

    function getScoreClass(nota){ if(nota>=8) return 'score-high'; if(nota>=6) return 'score-medium'; return 'score-low'; }

    async function carregarHistorico(){
      try{
        const { data: analises, error } = await supabase.from('analises_regua3').select('*').order('created_at',{ascending:false});
        if (error) { console.error('Erro ao buscar hist√≥rico:', error); return; }
        atualizarTabelaHistorico(analises||[]);
      }catch(e){ console.error('Erro ao carregar hist√≥rico:', e); }
    }

    function atualizarTabelaHistorico(analises){
      const tbody = document.querySelector('#historicoCompleto tbody'); tbody.innerHTML='';
      analises.forEach(a=>{
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${a.jogo||'-'}</td><td>${a.campeonato||'-'}</td>
          <td><span class="confidence-indicator ${getClasseNivel(a.nivel_confianca||'')}">${a.nivel_confianca||'-'}</span></td>
          <td>${a.cenario_classificacao||'-'}</td><td>${a.percentual_confianca||'-'}%</td>
          <td>${a.previsao_regua||'-'}</td><td>${a.resultado_real||'-'}</td><td>${a.acerto||'-'}</td>
          <td><button class="btn" onclick="verDetalhes('${a.id}')">Ver Detalhes</button></td>`;
      });
    }

    function filtrarHistorico(){ carregarHistorico(); }
    function verDetalhes(id){ alert(`Ver detalhes da an√°lise ${id}`); }
  </script>
</body>
</html>
