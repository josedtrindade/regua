<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√©gua 3.0 - An√°lise de Dupla Camada com OpenAI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100% );min-height:100vh;color:#333}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .header{text-align:center;color:white;margin-bottom:30px}
    .header h1{font-size:2.5rem;margin-bottom:10px}
    .header p{font-size:1.2rem;opacity:.9}
    .tabs{display:flex;background:white;border-radius:10px;margin-bottom:20px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .tab{flex:1;padding:15px 20px;background:#f8f9fa;border:none;cursor:pointer;font-size:1rem;font-weight:600;transition:all .3s}
    .tab.active{background:#667eea;color:#fff}
    .tab:hover{background:#5a6fd8;color:#fff}
    .content{background:#fff;border-radius:10px;padding:30px;box-shadow:0 4px 15px rgba(0,0,0,.1);min-height:500px}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:10px;text-align:center}
    .stat-card h3{font-size:2rem;margin-bottom:5px}
    .stat-card p{opacity:.9}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:5px;font-weight:600;color:#333}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:8px;font-size:1rem;transition:border-color .3s}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
    .btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:12px 30px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:transform .2s}
    .btn:hover{transform:translateY(-2px)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-outline{background:transparent;border:2px solid #667eea;color:#667eea}
    .btn-outline:hover{background:#667eea;color:#fff}
    .url-inputs{display:grid;gap:15px;margin-bottom:20px}
    .confidence-indicator{padding:10px;border-radius:8px;margin:10px 0;font-weight:600;text-align:center}
    .verde-escuro{background:#1e7e34;color:#fff}
    .verde-claro{background:#28a745;color:#fff}
    .amarelo{background:#ffc107;color:#333}
    .laranja{background:#fd7e14;color:#fff}
    .vermelho{background:#dc3545;color:#fff}
    .loading{text-align:center;padding:20px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .chart-container{position:relative;height:400px;margin:20px 0}
    .table-container{overflow-x:auto;margin-top:20px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}
    th{background:#f8f9fa;font-weight:600}
    tr:hover{background:#f8f9fa}
    .success{background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin:10px 0}
    .error{background:#f8d7da;color:#721c24;padding:15px;border-radius:8px;margin:10px 0}
    .connection-status{padding:10px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}
    .connected{background:#d4edda;color:#155724}
    .disconnected{background:#f8d7da;color:#721c24}
    .ai-status{display:flex;gap:10px;margin-bottom:20px}
    .ai-indicator{flex:1;padding:8px;border-radius:6px;text-align:center;font-size:.9rem;font-weight:600}
    .ai-active{background:#d4edda;color:#155724}
    .ai-inactive{background:#f8d7da;color:#721c24}
    .analysis-steps{background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0}
    .step{display:flex;align-items:center;margin:8px 0;padding:5px}
    .step-icon{width:20px;height:20px;border-radius:50%;margin-right:10px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
    .step-pending{background:#6c757d;color:#fff}
    .step-active{background:#007bff;color:#fff}
    .step-complete{background:#28a745;color:#fff}
    .step-error{background:#dc3545;color:#fff}
    .security-badge{background:#28a745;color:#fff;padding:5px 10px;border-radius:15px;font-size:.8rem;margin-left:10px}
    .analysis-section{background:#f8f9fa;padding:20px;border-radius:8px;margin:15px 0;border-left:4px solid #667eea}
    .layer-analysis{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0}
    .team-analysis{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .criteria-table{width:100%;margin-top:10px}
    .criteria-table th,.criteria-table td{padding:8px;text-align:center;border:1px solid #ddd}
    .score-high{background:#d4edda;color:#155724}
    .score-medium{background:#fff3cd;color:#856404}
    .score-low{background:#f8d7da;color:#721c24}
    .recommendations-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
    .recommendation-card{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1);text-align:center}
    .recommendation-card h4{color:#667eea;margin-bottom:10px}
    .collapsible{background:#f1f1f1;color:#444;cursor:pointer;padding:15px;width:100%;border:none;text-align:left;outline:none;font-size:15px;font-weight:600;border-radius:5px;margin:5px 0}
    .collapsible:hover{background:#ddd}
    .collapsible.active{background:#667eea;color:#fff}
    .collapsible-content{padding:0 15px;max-height:0;overflow:hidden;transition:max-height .2s ease-out;background:#fff;border-radius:0 0 5px 5px}
    .collapsible-content.active{padding:15px;max-height:1000px}

    /* ====== LANDING (p√°gina de vendas) ‚Äî CSS unificado ====== */
    #landing { max-width: 1100px; margin: 30px auto; padding: 0 20px; color:#fff }
    .landing-hero {
      background: rgba(255,255,255,.9);
      border-radius: 14px; padding: 28px;
      box-shadow: 0 10px 24px rgba(0,0,0,.12); text-align: center;
    }
    .landing-hero h1 { font-size: 2rem; margin-bottom: 10px; color: #222; }
    .landing-hero p { color: #444; margin-bottom: 16px; }
    .badges { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    .badges span { background:#eef2ff; color:#3f47c6; padding:6px 10px; border-radius:999px; font-weight:600; font-size:.9rem; }
    .cta-buttons { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0 5px; }
    .btn.btn-outline { background:#fff; color:#667eea; border:2px solid #667eea; }
    .btn.btn-outline:hover { background:#eef2ff; }
    .features-grid { margin-top:18px; display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }
    .feature-card { background:#fff; border-radius:12px; padding:16px; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .feature-card h3 { color:#4a57e2; margin-bottom:6px; }
    .feature-card p { color:#555; }

    /* ====== BLOCO DE LOGIN ====== */
    #auth{max-width:480px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.12);padding:20px}
    #auth h2{margin-bottom:10px}
    #status{color:#fff;text-align:center;margin:10px auto}
    .topbar{display:none;justify-content:space-between;align-items:center;max-width:1400px;margin:0 auto;padding:10px 20px;color:#fff}
    .topbar .right{display:flex;gap:10px;align-items:center}

    /* ---- Inline validation (novas classes) ---- */
    .help-text{color:#dc3545;font-size:.85rem;margin-top:6px;display:none}
    .help-text.show{display:block}
    .input-error{border-color:#dc3545 !important}
  </style>
</head>
<body>

  <!-- Status + Topbar (aparece quando logado) -->
  <div id="status">Carregando‚Ä¶</div>
  <div class="topbar" id="topbar">
    <div><strong>R√©gua 3.0</strong></div>
    <div class="right">
      <span id="whoami"></span>
      <button class="btn" id="btn-logout" style="padding:8px 14px">Sair</button>
    </div>
  </div>

  <!-- LANDING (vis√≠vel quando N√ÉO logado) -->
  <section id="landing" style="display:none">
    <div class="landing-hero">
      <h1>R√©gua 3.0 ‚Äì An√°lises profissionais para apostar com m√©todo</h1>
      <p>Metodologia de Dupla Camada com 12 diretrizes. Leia o jogo como um analista ‚Äî sem achismo.</p>
      <div class="cta-buttons">
        <button class="btn" onclick="showLogin()">Come√ßar agora</button>
        <a class="btn btn-outline" href="#metodologia">Ver metodologia</a>
      </div>
      <div class="badges">
        <span>‚úîÔ∏è Dupla Camada</span>
        <span>‚úîÔ∏è Regras de Zebra e Volatilidade</span>
        <span>‚úîÔ∏è Recomenda√ß√µes por mercado</span>
      </div>
    </div>

    <div class="features-grid">
      <div class="feature-card">
        <h3>üìä Camada 1 ‚Äì Circunstancial</h3>
        <p>9 crit√©rios (motiva√ß√£o, desfalques, psicol√≥gico, log√≠stica...) com justificativas.</p>
      </div>
      <div class="feature-card">
        <h3>üèóÔ∏è Camada 2 ‚Äì Estrutural</h3>
        <p>4 crit√©rios ponderados (elenco, padr√£o t√°tico, resili√™ncia, t√©cnico/gest√£o).</p>
      </div>
      <div class="feature-card">
        <h3>üéØ Veredito + Cores</h3>
        <p>Classifica√ß√£o Verde/Vermelho com % de confian√ßa e recomenda√ß√µes (1X, X2, 12, Triplo).</p>
      </div>
    </div>
  </section>

  <!-- BLOCO DE LOGIN (vis√≠vel quando N√ÉO logado) -->
  <div id="auth" style="display:none">
    <h2>Entrar ou Criar Conta</h2>
    <div class="form-group">
      <label for="email">E-mail</label>
      <input id="email" type="email" placeholder="voce@email.com"/>
      <small id="emailHelp" class="help-text"></small>
    </div>
    <div class="form-group">
      <label for="password">Senha</label>
      <input id="password" type="password" placeholder="Sua senha"/>
      <small id="passwordHelp" class="help-text"></small>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btn-login">Entrar</button>
      <button class="btn" id="btn-signup" type="button">Criar conta</button>
      <button class="btn" id="btn-forgot" type="button">Esqueci a senha</button>
    </div>
    <p style="margin-top:10px;color:#555;font-size:.9rem">
      * Voc√™ receber√° um e-mail de confirma√ß√£o ao criar a conta e, se precisar, um link para redefinir a senha.
    </p>
  </div>

  <!-- APP (vis√≠vel quando logado) -->
  <div id="app" style="display:none">
    <div class="container">
      <div class="header">
        <h1>‚öΩ R√©gua 3.0 - An√°lise de Dupla Camada</h1>
        <p>Sistema Inteligente de An√°lise de Futebol com Metodologia Completa <span class="security-badge">üîí SEGURO</span></p>
      </div>

      <div id="connectionStatus" class="connection-status disconnected">üîÑ Conectando ao banco de dados...</div>

      <div class="ai-status">
        <div id="openaiStatus" class="ai-indicator ai-active">üß† OpenAI GPT-4: Ativo e Seguro</div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard', event)">üìä Dashboard</button>
        <button class="tab" onclick="showTab('nova-analise', event)">‚ûï Nova An√°lise</button>
        <button class="tab" onclick="showTab('historico', event)">üìã Hist√≥rico</button>
        <button class="tab" onclick="showTab('metodologia', event)">üìö Metodologia</button>
        <button class="tab" onclick="showTab('sobre', event)">‚ÑπÔ∏è Sobre</button>
      </div>

      <div class="content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
          <h2>üìä Performance da R√©gua 3.0</h2>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><h3 id="totalJogos">-</h3><p>Total de Jogos</p></div>
            <div class="stat-card"><h3 id="taxaAcerto">-</h3><p>Taxa de Acerto Geral</p></div>
            <div class="stat-card"><h3 id="verdeEscuroAcerto">-</h3><p>Verde Escuro</p></div>
            <div class="stat-card"><h3 id="verdeClaroAcerto">-</h3><p>Verde Claro</p></div>
            <div class="stat-card"><h3 id="amareloAcerto">-</h3><p>Amarelo</p></div>
            <div class="stat-card"><h3 id="laranjaAcerto">-</h3><p>Laranja</p></div>
          </div>

          <div class="chart-container"><canvas id="performanceChart"></canvas></div>

          <div class="table-container">
            <h3>üéØ √öltimas An√°lises</h3>
            <table id="ultimasAnalises">
              <thead>
              <tr><th>Jogo</th><th>N√≠vel</th><th>Cen√°rio</th><th>Previs√£o</th><th>Resultado</th><th>Acerto</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Nova An√°lise Tab -->
        <div id="nova-analise" class="tab-content">
          <h2>‚ûï Nova An√°lise com R√©gua 3.0</h2>
          <div class="success">
            <h4>üîí Sistema Seguro</h4>
            <p>Sua chave OpenAI est√° protegida no servidor. A an√°lise segue fielmente a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada" com 12 diretrizes espec√≠ficas.</p>
          </div>

          <form id="novaAnaliseForm">
            <div class="form-group">
              <label>üèÜ Jogo (ex: Flamengo x Palmeiras)</label>
              <input type="text" id="jogoInput" placeholder="Time Mandante x Time Visitante" required>
            </div>

            <div class="form-group">
              <label>üèÜ Campeonato</label>
              <input type="text" id="campeonatoInput" placeholder="Ex: Campeonato Brasileiro - S√©rie A" required>
            </div>

            <div class="url-inputs">
              <div class="form-group">
                <label>üì∞ URL Not√≠cia 1 (obrigat√≥ria)</label>
                <input type="url" id="url1" placeholder="https://globoesporte.globo.com/..." required>
              </div>
              <div class="form-group">
                <label>üì∞ URL Not√≠cia 2 (opcional )</label>
                <input type="url" id="url2" placeholder="https://espn.com.br/...">
              </div>
              <div class="form-group">
                <label>üì∞ URL Not√≠cia 3 (opcional )</label>
                <input type="url" id="url3" placeholder="https://lance.com.br/...">
              </div>
            </div>

            <button type="submit" class="btn" id="analisarBtn">üß† Analisar com R√©gua 3.0</button>
          </form>

          <div id="analysisSteps" class="analysis-steps" style="display:none">
            <h4>üîÑ Progresso da An√°lise:</h4>
            <div class="step" id="step1"><div class="step-icon step-pending">1</div><span>Coletando dados das URLs...</span></div>
            <div class="step" id="step2"><div class="step-icon step-pending">2</div><span>Aplicando as 12 diretrizes de pondera√ß√£o...</span></div>
            <div class="step" id="step3"><div class="step-icon step-pending">3</div><span>Executando Camada 1 (9 crit√©rios circunstanciais )...</span></div>
            <div class="step" id="step4"><div class="step-icon step-pending">4</div><span>Executando Camada 2 (4 crit√©rios estruturais)...</span></div>
            <div class="step" id="step5"><div class="step-icon step-pending">5</div><span>Gerando veredito final e recomenda√ß√µes...</span></div>
            <div class="step" id="step6"><div class="step-icon step-pending">6</div><span>Salvando an√°lise completa...</span></div>
          </div>

          <div id="resultadoAnalise" style="margin-top:30px;"></div>
        </div>

        <!-- Hist√≥rico Tab -->
        <div id="historico" class="tab-content">
          <h2>üìã Hist√≥rico Completo</h2>
          <div class="form-group">
            <label>üîç Filtrar por N√≠vel</label>
            <select id="filtroNivel" onchange="filtrarHistorico()">
              <option value="">Todos os n√≠veis</option>
              <option value="Verde Escuro">Verde Escuro (90-100%)</option>
              <option value="Verde Claro">Verde Claro (80-89%)</option>
              <option value="Amarelo">Amarelo (70-79%)</option>
              <option value="Laranja">Laranja (60-69%)</option>
              <option value="Vermelho">Vermelho (&lt;60%)</option>
            </select>
          </div>

          <div class="table-container">
            <table id="historicoCompleto">
              <thead>
              <tr>
                <th>Jogo</th><th>Campeonato</th><th>N√≠vel</th><th>Cen√°rio</th>
                <th>Confian√ßa %</th><th>Previs√£o</th><th>Resultado</th><th>Acerto</th><th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Metodologia Tab -->
        <div id="metodologia" class="tab-content">
          <!-- (seu conte√∫do da metodologia) -->
        </div>

        <!-- Sobre Tab -->
        <div id="sobre" class="tab-content">
          <!-- (seu conte√∫do do Sobre) -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG DO SUPABASE (seu projeto) =====
    const SUPABASE_URL = 'https://shjjweviipblcjukvxry.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNoamp3ZXZpaXBibGNqdWt2eHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjY1NDMsImV4cCI6MjA3MjQ0MjU0M30.LJmmMKDASQfvDo4D_S-tbHDUh2jUb2VuFwl3EqrLBas';

    let supabase = null;

    // ======= BOOT =======
    document.addEventListener('DOMContentLoaded', async ( ) => {
      inicializarSupabase();              // cria o client
      configurarAutenticacao();           // listeners de auth
      await refreshUI();                  // mostra login ou app
      if (await isLogged()) {             // s√≥ carrega dados se logado
        carregarDashboard();
      }
      inicializarCollapsibles();

      // limpa inline errors ao digitar
      ['email','password'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', ()=>clearFieldError(el));
      });
    });

    // ======= SUPABASE CLIENT =======
    function inicializarSupabase() {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        setConnStatus(true);
      } catch (error) {
        console.error('Erro ao conectar:', error);
        setConnStatus(false);
      }
    }

    function setConnStatus(ok){
      const el = document.getElementById('connectionStatus');
      if(!el) return;
      el.innerHTML = ok ? '‚úÖ Conectado ao banco de dados' : '‚ùå Erro na conex√£o com banco';
      el.className = 'connection-status ' + (ok ? 'connected' : 'disconnected');
    }

    // ======= AUTH UI =======
    async function isLogged(){
      const { data:{ session } } = await supabase.auth.getSession();
      return !!session;
    }

    async function refreshUI(){
      const logged = await isLogged();
      const { data:{ session } } = await supabase.auth.getSession();

      const statusEl = document.getElementById('status');
      const authEl   = document.getElementById('auth');
      const appEl    = document.getElementById('app');
      const topbar   = document.getElementById('topbar');
      const whoami   = document.getElementById('whoami');
      const landingEl = document.getElementById('landing');

      if (logged) {
        authEl.style.display = 'none';
        landingEl.style.display = 'none';
        appEl.style.display  = 'block';
        topbar.style.display = 'flex';
        statusEl.textContent = 'Logado';
        if (whoami && session?.user?.email) whoami.textContent = session.user.email;
      } else {
        appEl.style.display  = 'none';
        topbar.style.display = 'none';
        authEl.style.display = 'none';
        landingEl.style.display = 'block';
        statusEl.textContent = 'N√£o logado';
      }
    }

    function showLogin(){
      const landingEl = document.getElementById('landing');
      const authEl = document.getElementById('auth');
      if (landingEl) landingEl.style.display = 'none';
      if (authEl) {
        authEl.style.display = 'block';
        authEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        const email = document.getElementById('email');
        if (email) setTimeout(()=>email.focus(), 200);
      }
    }

    function showFieldError(input, msg, helpId){
      if (!input) return;
      input.classList.add('input-error');
      const help = document.getElementById(helpId);
      if (help){ help.textContent = msg; help.classList.add('show'); }
      input.focus();
    }
    function clearFieldError(input){
      if (!input) return;
      input.classList.remove('input-error');
      const helpId = (input.id === 'email') ? 'emailHelp' : (input.id === 'password' ? 'passwordHelp' : null);
      if (helpId){
        const help = document.getElementById(helpId);
        if (help){ help.textContent = ''; help.classList.remove('show'); }
      }
    }

    function configurarAutenticacao(){
      supabase.auth.onAuthStateChange(async (_event,_session)=> {
        await refreshUI();
        if (await isLogged()) carregarDashboard();
      });

      document.getElementById('btn-signup').onclick = async () => {
        const emailEl = document.getElementById('email');
        const passEl  = document.getElementById('password');
        let email = (emailEl?.value || '').trim();
        const password = passEl?.value || '';

        if (!email) { showFieldError(emailEl,'Informe seu e-mail.','emailHelp'); return; }
        if (emailEl && typeof emailEl.checkValidity === 'function' && !emailEl.checkValidity()) {
          showFieldError(emailEl,'E-mail inv√°lido.','emailHelp'); return;
        }
        if (!email.includes('@')) { showFieldError(emailEl,'E-mail inv√°lido.','emailHelp'); return; }
        if (!password) { showFieldError(passEl,'Defina uma senha.','passwordHelp'); return; }
        if (password.length < 6) { showFieldError(passEl,'Use ao menos 6 caracteres.','passwordHelp'); return; }

        email = email.toLowerCase();
        const { error } = await supabase.auth.signUp({ email, password });

        if (error) {
          const msg = String(error.message || '').toLowerCase();
          if (msg.includes('anonymous')) {
            showFieldError(emailEl,'Preencha e-mail e senha. Cadastros an√¥nimos est√£o desativados.','emailHelp');
          } else {
            showFieldError(emailEl,error.message,'emailHelp');
          }
          return;
        }
        clearFieldError(emailEl); clearFieldError(passEl);
        alert('Cadastro criado! Confirme seu e-mail para ativar a conta.');
      };

      document.getElementById('btn-login').onclick = async () => {
        const emailEl = document.getElementById('email');
        const passEl  = document.getElementById('password');
        let email = (emailEl?.value || '').trim();
        const password = passEl?.value || '';

        if (!email) { showFieldError(emailEl,'Informe seu e-mail.','emailHelp'); return; }
        if (emailEl && typeof emailEl.checkValidity === 'function' && !emailEl.checkValidity()) {
          showFieldError(emailEl,'E-mail inv√°lido.','emailHelp'); return;
        }
        if (!email.includes('@')) { showFieldError(emailEl,'E-mail inv√°lido.','emailHelp'); return; }
        if (!password) { showFieldError(passEl,'Informe sua senha.','passwordHelp'); return; }

        email = email.toLowerCase();
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          showFieldError(passEl, error.message || 'Falha no login.', 'passwordHelp');
          return;
        }
        clearFieldError(emailEl); clearFieldError(passEl);
      };

      document.getElementById('btn-forgot').onclick = async () => {
        const emailEl = document.getElementById('email');
        const email = (emailEl?.value || '').trim();
        if (!email) { showFieldError(emailEl,'Digite seu e-mail antes.','emailHelp'); return; }
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: 'https://regua.netlify.app/reset' } );
        if (error) {
          showFieldError(emailEl, error.message || 'N√£o foi poss√≠vel enviar o e-mail.', 'emailHelp');
        } else {
          const help = document.getElementById('emailHelp');
          if (help){ help.textContent = 'Enviamos um e-mail com o link para redefinir sua senha.'; help.classList.add('show'); }
        }
      };

      document.getElementById('btn-logout').onclick = async () => {
        await supabase.auth.signOut();
      };
    }

    function inicializarCollapsibles() {
      const collapsibles = document.querySelectorAll('.collapsible');
      collapsibles.forEach(collapsible => {
        collapsible.addEventListener('click', function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          content.classList.toggle('active');
        });
      });
    }

    function showTab(tabName, ev) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      if (ev && ev.target) ev.target.classList.add('active');

      if (tabName === 'dashboard')      carregarDashboard();
      else if (tabName === 'historico') carregarHistorico();
    }

    async function carregarDashboard() {
      try {
        const { data: analises, error } = await supabase
          .from('analises_regua3')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Erro ao buscar an√°lises para o dashboard:', error);
          // Mostra um erro amig√°vel na tela se o dashboard n√£o puder ser carregado
          document.getElementById('statsGrid').innerHTML = `<p class="error">N√£o foi poss√≠vel carregar as estat√≠sticas.</p>`;
          return;
        }

        // Se chegar aqui, a busca foi bem-sucedida, mesmo que 'analises' seja um array vazio
        const stats = calcularEstatisticas(analises || []);
        atualizarDashboard(stats);
        criarGrafico(stats);
        const ultimasAnalises = (analises || []).slice(0, 10);
        atualizarTabelaUltimas(ultimasAnalises);

      } catch (error) {
        // Pega erros que podem acontecer em calcularEstatisticas ou outras fun√ß√µes
        console.error('Erro cr√≠tico ao carregar o dashboard:', error);
        document.getElementById('dashboard').innerHTML = `<div class="error"><h3>Ocorreu um erro inesperado</h3><p>N√£o foi poss√≠vel exibir o dashboard. Verifique o console (F12) para detalhes t√©cnicos. Pode haver um dado corrompido no banco.</p></div>`;
      }
    }

    // =================================================================
    // >>>>> FUN√á√ÉO CORRIGIDA PARA EVITAR TRAVAMENTO (ROBUSTA) <<<<<
    // =================================================================
    function calcularEstatisticas(analises) {
      const stats = {
        total: analises.length, acertos: 0,
        verdeEscuro:{total:0,acertos:0}, verdeClaro:{total:0,acertos:0},
        amarelo:{total:0,acertos:0}, laranja:{total:0,acertos:0}, vermelho:{total:0,acertos:0}
      };

      if (!analises) return stats; // Retorna stats zerados se n√£o houver an√°lises

      analises.forEach(a => {
        // ---- IN√çCIO DA CORRE√á√ÉO DE ROBUSTEZ ----
        // Garante que 'a' (an√°lise) e 'a.acerto' existam antes de usar .includes()
        const acertou = a && a.acerto && (a.acerto.includes('‚úÖ') || a.acerto.includes('Pleno'));
        if (acertou) stats.acertos++;

        // Usa optional chaining (?.) para acessar 'nivel_confianca' de forma segura
        const nivel = a?.nivel_confianca || '';
        // ---- FIM DA CORRE√á√ÉO DE ROBUSTEZ ----

        if (nivel.includes('Verde Escuro')) {stats.verdeEscuro.total++; if (acertou) stats.verdeEscuro.acertos++;}
        else if (nivel.includes('Verde Claro')) {stats.verdeClaro.total++; if (acertou) stats.verdeClaro.acertos++;}
        else if (nivel.includes('Amarelo')) {stats.amarelo.total++; if (acertou) stats.amarelo.acertos++;}
        else if (nivel.includes('Laranja')) {stats.laranja.total++; if (acertou) stats.laranja.acertos++;}
        else if (nivel.includes('Vermelho')) {stats.vermelho.total++; if (acertou) stats.vermelho.acertos++;}
      });
      return stats;
    }

    function atualizarDashboard(stats){
      document.getElementById('totalJogos').textContent = stats.total;
      document.getElementById('taxaAcerto').textContent =
        stats.total > 0 ? Math.round((stats.acertos / stats.total) * 100) + '%' : '0%';
      document.getElementById('verdeEscuroAcerto').textContent =
        stats.verdeEscuro.total > 0 ? Math.round((stats.verdeEscuro.acertos / stats.verdeEscuro.total) * 100) + '%' : '0%';
      document.getElementById('verdeClaroAcerto').textContent =
        stats.verdeClaro.total > 0 ? Math.round((stats.verdeClaro.acertos / stats.verdeClaro.total) * 100) + '%' : '0%';
      document.getElementById('amareloAcerto').textContent =
        stats.amarelo.total > 0 ? Math.round((stats.amarelo.acertos / stats.amarelo.total) * 100) + '%' : '0%';
      document.getElementById('laranjaAcerto').textContent =
        stats.laranja.total > 0 ? Math.round((stats.laranja.acertos / stats.laranja.total) * 100) + '%' : '0%';
    }

    function criarGrafico(stats){
      const ctx = document.getElementById('performanceChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type:'bar',
        data:{
          labels:['Verde Escuro','Verde Claro','Amarelo','Laranja','Vermelho'],
          datasets:[{label:'Taxa de Acerto (%)',data:[
            stats.verdeEscuro.total ? Math.round((stats.verdeEscuro.acertos/stats.verdeEscuro.total)*100) : 0,
            stats.verdeClaro.total ? Math.round((stats.verdeClaro.acertos/stats.verdeClaro.total)*100) : 0,
            stats.amarelo.total ? Math.round((stats.amarelo.acertos/stats.amarelo.total)*100) : 0,
            stats.laranja.total ? Math.round((stats.laranja.acertos/stats.laranja.total)*100) : 0,
            stats.vermelho.total ? Math.round((stats.vermelho.acertos/stats.vermelho.total)*100) : 0
          ], backgroundColor:['#1e7e34','#28a745','#ffc107','#fd7e14','#dc3545']}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}
      });
    }

    function atualizarTabelaUltimas(analises){
      const tbody = document.querySelector('#ultimasAnalises tbody');
      tbody.innerHTML='';
      if (!analises || analises.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nenhuma an√°lise recente.</td></tr>';
        return;
      }
      analises.forEach(analise=>{
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${analise.jogo || '-'}</td>
          <td><span class="confidence-indicator ${getClasseNivel(analise.nivel_confianca || '')}">${analise.nivel_confianca || '-'}</span></td>
          <td>${analise.cenario_classificacao || '-'}</td>
          <td>${analise.previsao_regua || '-'}</td>
          <td>${analise.resultado_real || 'Pendente'}</td>
          <td>${analise.acerto || 'Pendente'}</td>`;
      });
    }

    function getClasseNivel(nivel){
      if (!nivel) return '';
      if (nivel.includes('Verde Escuro')) return 'verde-escuro';
      if (nivel.includes('Verde Claro')) return 'verde-claro';
      if (nivel.includes('Amarelo')) return 'amarelo';
      if (nivel.includes('Laranja')) return 'laranja';
      if (nivel.includes('Vermelho')) return 'vermelho';
      return '';
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const form = document.getElementById('novaAnaliseForm');
      if (!form) return;
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!supabase){ alert('‚ùå Erro na conex√£o com banco de dados!'); return; }

        const jogo = document.getElementById('jogoInput').value;
        const campeonato = document.getElementById('campeonatoInput').value;
        const urls = [document.getElementById('url1').value, document.getElementById('url2').value, document.getElementById('url3').value].filter(u=>u.trim());
        if (urls.length===0){ alert('‚ùå Adicione pelo menos uma URL de not√≠cia!'); return; }

        resetNovaAnaliseView(); // Garante que a view esteja limpa
        document.getElementById('analysisSteps').style.display='block';
        document.getElementById('resultadoAnalise').innerHTML='';
        document.getElementById('analisarBtn').disabled=true;

        try {
          await analisarComRegua3(jogo, campeonato, urls);
        } catch (err) {
          console.error('Erro na an√°lise:', err);
          updateStep('step5', 'error'); // Marca o erro no passo 5 ou 6
          updateStep('step6', 'error');
          document.getElementById('resultadoAnalise').innerHTML =
            `<div class="error"><h3>‚ùå Erro na An√°lise</h3><p>${err.message}</p><p><small>Verifique o console (F12) para mais detalhes e confirme se a chave OpenAI est√° configurada corretamente no servidor.</small></p></div>`;
        } finally {
          document.getElementById('analisarBtn').disabled=false;
        }
      });
    });

    async function analisarComRegua3(jogo, campeonato, urls){
      updateStep('step1','active');
      const conteudos = await extrairConteudoURLs(urls);
      updateStep('step1','complete');

      updateStep('step2','active'); await delay(1000); updateStep('step2','complete');
      updateStep('step3','active'); await delay(1000); updateStep('step3','complete');
      updateStep('step4','active'); await delay(1000); updateStep('step4','complete');

      updateStep('step5','active');
      const analiseCompleta = await analisarConteudoComRegua3(jogo, campeonato, conteudos, urls);
      updateStep('step5','complete');

      updateStep('step6','active');
      try{
        await salvarAnaliseNoBanco(analiseCompleta);
        updateStep('step6','complete');
      } catch (e){
        updateStep('step6','error');
        const tgt = document.getElementById('resultadoAnalise');
        if (tgt){
          tgt.innerHTML = `<div class="error"><h3>‚ùå Erro ao salvar an√°lise</h3><p>${e.message}</p></div>`;
        }
        throw e;
      }

      mostrarResultadoAnalise(analiseCompleta);
      carregarDashboard();
    }

    function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function updateStep(stepId,status){
      const step = document.getElementById(stepId); if(!step) return;
      const icon = step.querySelector('.step-icon');
      icon.className = `step-icon step-${status}`;
      if (status==='complete') icon.innerHTML='‚úì';
      else if (status==='error') icon.innerHTML='‚úó';
      else { // pending ou active
        const stepNumber = stepId.replace('step', '');
        icon.innerHTML = stepNumber;
      }
    }

    async function extrairConteudoURLs(urls){
      const conteudos=[];
      for (const url of urls){
        try{
          const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url )}`);
          if (!response.ok) throw new Error(`Falha na requisi√ß√£o: ${response.statusText}`);
          const data = await response.json();
          const parser = new DOMParser();
          const doc = parser.parseFromString(data.contents,'text/html');
          doc.querySelectorAll('script, style').forEach(elem => elem.remove());
          const texto = doc.body.innerText.substring(0,3000);
          conteudos.push({ url, conteudo:texto });
        }catch(e){
          console.error(`Erro ao extrair ${url}:`, e);
          conteudos.push({ url, conteudo:'Erro ao extrair conte√∫do. Verifique o console.' });
        }
      }
      return conteudos;
    }

    async function analisarConteudoComRegua3(jogo, campeonato, conteudos, urls){
      const promptCompleto = `Voc√™ √© um Analista de Futebol S√™nior, aut√¥nomo e proativo. Sua tarefa √© realizar uma an√°lise completa de uma partida de futebol usando a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada".

DADOS DA PARTIDA:
Campeonato: ${campeonato}
Partida: ${jogo}

DIRETRIZES DE AN√ÅLISE AVAN√áADA (REGRAS DE PONDERA√á√ÉO):
Antes de iniciar a avalia√ß√£o, voc√™ deve aplicar as seguintes diretrizes de pondera√ß√£o para cen√°rios espec√≠ficos do futebol brasileiro ou internacional. Elas se sobrep√µem √† avalia√ß√£o padr√£o para garantir uma an√°lise mais precisa e sutil.

Diretriz 1: "Regra do Desgaste Log√≠stico" (An√°logo √† Vantagem Extrema)
Cen√°rio: Se uma equipe (especialmente a visitante) jogou uma partida decisiva de mata-mata no meio da semana, envolvendo uma viagem longa.
A√ß√£o: Travar J (Log√≠stica/Fadiga) em ‚â§ 3/10 para essa equipe, considerar time misto/reserva em C (Desfalques) e explicitar baixa intensidade que aumenta chance de resultado surpreendente.

Diretriz 2: "Regra do Cl√°ssico de Desespero" (An√°logo ao Equil√≠brio T√°tico do 0x0)
Cen√°rio: Cl√°ssico regional com um time no topo (t√≠tulo/G4) vs. outro no Z4.
A√ß√£o: B (Motiva√ß√£o) do desesperado = 10/10; D (Psicol√≥gico) do favorito com risco de complac√™ncia/press√£o; reconhecer neutraliza√ß√£o parcial da diferen√ßa t√©cnica.

Diretriz 3: "Regra do Fator Clim√°tico/Campo" (An√°logo da Altitude)
Cen√°rio: Calor extremo/gramado pesado.
A√ß√£o: Potencializar F (Mando de Campo) do mandante; em G (Elenco/Estrat√©gia) reduzir peso da superioridade t√©cnica do visitante se for time de toque de bola; jogo tende a ser mais f√≠sico.

Diretriz 4: "Regra do Le√£o Ferido" (Revers√£o √† m√©dia local)
Cen√°rio: Time qualificado em 3+ jogos sem vencer, jogando em casa contra advers√°rio em boa fase (similar/um pouco inferior).
A√ß√£o: F (Mando) ‚â• 9; reduzir peso de H (Forma) do advers√°rio; tend√™ncia de jogo mais agressivo ‚Üí tend√™ncia a Over 2.5.

Diretriz 5: "Alerta de Zebra por Calamidade"
Cen√°rio: Mandante com 5+ desfalques importantes e visitante sem press√£o.
A√ß√£o: Classificar como "Risco Imponder√°vel"; evitar palpite seco; na Loteca sugerir Triplo (1X2); explicitar que a l√≥gica aponta visitante, mas cen√°rio de supera√ß√£o equaliza.

Diretriz 6: "Ressaca Heroica"
Cen√°rio: Time vem de grande feito na semana (classifica√ß√£o/t√≠tulo/cl√°ssico) e enfrenta advers√°rio teoricamente mais fraco, principalmente fora.
A√ß√£o: D (Psicol√≥gico) moderado (6-7/10), classificar como "Risco de Complac√™ncia"; evitar aposta seca; preferir Duplo Aberto (12) ou at√© Triplo.

Diretriz 7: "Revers√£o √† M√©dia (Despertar do Gigante)"
Cen√°rio: Elenco superior (Crit√©rio 1 ‚â• 8) em jejum de 5+ jogos vs. elenco inferior em boa fase.
A√ß√£o: Reduzir peso de H (Forma recente); valorizar Crit√©rio 1 (fator latente); classificar como "Alto Risco de Revers√£o"; evitar aposta seca; Duplo Aberto (12) ou Triplo na Loteca.

Diretriz 8: Times de Meio de Tabela x Mandantes Desesperados
S√©rie B (obrigat√≥rio): Visitante 7¬∫ pra baixo contra mandante no Z4 em casa NUNCA recebe Verde Escuro/Verde Claro ‚Üí no m√≠nimo Amarelo com empate prov√°vel.
S√©rie A: aplica para visitante 8¬∫‚Äì12¬∫; G4/G6 mant√©m leitura normal.
Europa: s√≥ aplicar se houver crise documentada.

Diretriz 9: Empate na Ida
Regra: Se o favorito empatou a ida fora, rebaixe um n√≠vel de cor (VE‚ÜíVC; VC‚ÜíAmarelo), exceto se a ida j√° estava resolvida (3+ gols).

Diretriz 10: O Miolo Perigos√≠ssimo (diferen√ßa 0‚Äì2 pts)
Classifica√ß√£o: Vermelho (<60%) ‚Üí sempre Triplo (1X2). Zona de imprevisibilidade m√°xima; n√£o h√° vi√©s de placar confi√°vel.

Diretriz 11: Alerta de Zebra no Verde Claro
Se VC (80‚Äì89%), checar: (i) favorito goleia ou vence magro? (ii) visitante defende bem? (iii) desfalques ofensivos do favorito?
Se ‚â•2 positivos ‚Üí rebaixar para ~75% (Amarelo). Mudar de aposta seca para Duplo Aberto (12) ou Duplo Fechado (1X).

Diretriz 12: Volatilidade Amarela
No Amarelo (70‚Äì79%), avaliar potencial ofensivo do azar√£o: m√©dia de gols, defesa fr√°gil do favorito fora, artilheiro em fase.
Se ‚â•2 positivos ‚Üí incluir placares el√°sticos e tender a Over 2.5/3.5. Se houver "Ressaca Heroica", baixar D e J.

FLUXO DE TRABALHO OBRIGAT√ìRIO (Coleta pr√©-an√°lise):
‚Ä¢ Posi√ß√£o na tabela e campanha geral.
‚Ä¢ √öltimos 5 jogos de cada equipe.
‚Ä¢ Desfalques confirmados/prov√°veis (les√µes, suspens√µes).
‚Ä¢ Clima interno (crise, euforia, press√£o).
‚Ä¢ Hist√≥rico recente de confrontos diretos.
‚Ä¢ Log√≠stica (sequ√™ncia de jogos e viagens).

METODOLOGIA R√âGUA 3.0 ‚Äî AN√ÅLISE DE DUPLA CAMADA

PASSO 1: CAMADA 1 ‚Äî FOR√áA CIRCUNSTANCIAL (9 crit√©rios, 0‚Äì10)
Avalie e justifique para cada time:
B. Motiva√ß√£o
C. Desfalques
D. Psicol√≥gico
E. Momento na Tabela
F. Mando de Campo
G. Elenco/Estrat√©gia T√°tica (encaixe para este confronto)
H. Forma Recente
I. Confronto Direto
J. Log√≠stica/Fadiga
Em cada time, some um total (0‚Äì90) e apresente um "Sem√°foro do Jogo".

PASSO 2: CAMADA 2 ‚Äî FOR√áA ESTRUTURAL (√çndice Pr√°tico, ponderado)
Para cada time:
1. Qualidade Estrutural do Elenco (Peso 3)
2. Consist√™ncia / Padr√£o T√°tico (Peso 2)
3. Resili√™ncia Mental (Peso 2)
4. Fator T√©cnico/Gerencial (Peso 1)
Apresente "total_ponderado" (0‚Äì80).

PASSO 3: VEREDITO FINAL ‚Äî CONFLITOS e CEN√ÅRIO
Compare Camada 1 x Camada 2 e determine:
‚Ä¢ Vencedor circunstancial
‚Ä¢ Vencedor estrutural
‚Ä¢ Cen√°rio de classifica√ß√£o
‚Ä¢ N√≠vel e % de confian√ßa (faixas):
  üü¢ Verde Escuro (90‚Äì100%) ‚Üí apostar seco / coluna √∫nica
  üü¢ Verde Claro (80‚Äì89%) ‚Üí 1 ou 2, seguran√ßa 1X/2X
  üü° Amarelo (70‚Äì79%) ‚Üí duplo obrigat√≥rio (1X ou X2)
  üü† Laranja (60‚Äì69%) ‚Üí duplo aberto (12) ou Triplo
  üî¥ Vermelho (<60%) ‚Üí Triplo (1X2)
‚Ä¢ Liste quais diretrizes (1‚Äì12) foram aplicadas e como.

RECOMENDA√á√ïES PR√ÅTICAS:
‚Ä¢ Resultado Mais Prov√°vel
‚Ä¢ 2‚Äì3 placares prov√°veis
‚Ä¢ Mercado de Gols (Over/Under) e justificativa
‚Ä¢ Ambos Marcam (BTTS) e justificativa
‚Ä¢ Loteca (Coluna 1, Meio, 2; Duplo/Triplo quando necess√°rio)

CONTE√öDO DAS NOT√çCIAS (base para a coleta):
${conteudos.map(c => `URL: ${c.url}\nConte√∫do: ${c.conteudo}`).join('\n\n')}

Responda OBRIGATORIAMENTE em JSON com esta estrutura:
{
  "coleta_dados": {
    "posicao_tabela": "string",
    "ultimos_jogos": "string",
    "desfalques": "string",
    "clima_interno": "string",
    "historico_confrontos": "string",
    "logistica": "string"
  },
  "camada1_circunstancial": {
    "mandante": {
      "motivacao": {"nota": 0, "justificativa": "string"},
      "desfalques": {"nota": 0, "justificativa": "string"},
      "psicologico": {"nota": 0, "justificativa": "string"},
      "momento_tabela": {"nota": 0, "justificativa": "string"},
      "mando_campo": {"nota": 0, "justificativa": "string"},
      "elenco_estrategia": {"nota": 0, "justificativa": "string"},
      "forma_recente": {"nota": 0, "justificativa": "string"},
      "confronto_direto": {"nota": 0, "justificativa": "string"},
      "logistica_fadiga": {"nota": 0, "justificativa": "string"},
      "total": 0
    },
    "visitante": {
      "motivacao": {"nota": 0, "justificativa": "string"},
      "desfalques": {"nota": 0, "justificativa": "string"},
      "psicologico": {"nota": 0, "justificativa": "string"},
      "momento_tabela": {"nota": 0, "justificativa": "string"},
      "mando_campo": {"nota": 0, "justificativa": "string"},
      "elenco_estrategia": {"nota": 0, "justificativa": "string"},
      "forma_recente": {"nota": 0, "justificativa": "string"},
      "confronto_direto": {"nota": 0, "justificativa": "string"},
      "logistica_fadiga": {"nota": 0, "justificativa": "string"},
      "total": 0
    },
    "semaforo_jogo": "string"
  },
  "camada2_estrutural": {
    "mandante": {
      "qualidade_elenco": {"nota": 0, "peso": 3, "justificativa": "string"},
      "consistencia_tatica": {"nota": 0, "peso": 2, "justificativa": "string"},
      "resiliencia_mental": {"nota": 0, "peso": 2, "justificativa": "string"},
      "fator_gerencial": {"nota": 0, "peso": 1, "justificativa": "string"},
      "total_ponderado": 0
    },
    "visitante": {
      "qualidade_elenco": {"nota": 0, "peso": 3, "justificativa": "string"},
      "consistencia_tatica": {"nota": 0, "peso": 2, "justificativa": "string"},
      "resiliencia_mental": {"nota": 0, "peso": 2, "justificativa": "string"},
      "fator_gerencial": {"nota": 0, "peso": 1, "justificativa": "string"},
      "total_ponderado": 0
    }
  },
  "veredito_final": {
    "vencedor_circunstancial": "string",
    "vencedor_estrutural": "string",
    "cenario_classificacao": "string",
    "nivel_confianca": "string",
    "percentual_confianca": 0,
    "diretrizes_aplicadas": ["string"],
    "analise_final": "string"
  },
  "recomendacoes": {
    "resultado_provavel": "string",
    "placares_provaveis": ["string"],
    "mercado_gols": "string",
    "ambos_marcam": "string",
    "loteca": "string"
  }
}`;

      try{
        const response = await fetch('/.netlify/functions/openai-analysis', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            messages:[
              { role:'system', content:'Voc√™ √© um especialista em an√°lise t√°tica e predi√ß√£o de resultados de futebol. Responda sempre de forma precisa e utilit√°ria, seguindo o formato JSON solicitado.' },
              { role:'user', content: promptCompleto }
            ],
            model:'gpt-4',
            temperature:0,
            max_tokens:4096,
            response_format: { "type": "json_object" }
          })
        });
        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(`Erro na API: ${response.status} - ${errorBody}`);
        }
        const data = await response.json();
        const analiseJSON = JSON.parse(data.choices[0].message.content);
        analiseJSON.jogo = jogo;
        analiseJSON.campeonato = campeonato;
        analiseJSON.urls = urls;
        analiseJSON.timestamp = new Date().toISOString();
        return analiseJSON;
      } catch (error){
        console.error('Erro na an√°lise OpenAI:', error);
        throw error;
      }
    }

    async function getUserId() {
      const { data, error } = await supabase.auth.getUser();
      if (error || !data?.user?.id) return null;
      return data.user.id;
    }

    async function salvarAnaliseNoBanco(analise){
      const userId = await getUserId();
      if (!userId) {
        throw new Error('Voc√™ n√£o est√° autenticado. Fa√ßa login novamente.');
      }

      const linha = {
        user_id: userId,
        jogo: analise.jogo,
        campeonato: analise.campeonato,
        urls: analise.urls,
        coleta_dados: JSON.stringify(analise.coleta_dados || {}),
        camada1_circunstancial: JSON.stringify(analise.camada1_circunstancial || {}),
        camada2_estrutural: JSON.stringify(analise.camada2_estrutural || {}),
        veredito_final: JSON.stringify(analise.veredito_final || {}),
        recomendacoes: JSON.stringify(analise.recomendacoes || {}),
        nivel_confianca: analise.veredito_final?.nivel_confianca || null,
        percentual_confianca: analise.veredito_final?.percentual_confianca ?? null,
        cenario_classificacao: analise.veredito_final?.cenario_classificacao || null,
        previsao_regua: analise.recomendacoes?.resultado_provavel || null,
        created_at: new Date().toISOString()
      };

      const { data, error } = await supabase
        .from('analises_regua3')
        .insert([linha])
        .select('id');

      if (error) {
        console.error("Erro detalhado do Supabase:", error);
        throw new Error('Falha ao salvar no banco: ' + (error.message || JSON.stringify(error)));
      }
      
      console.log("An√°lise salva com sucesso! ID:", data?.[0]?.id);
      return data?.[0]?.id || null;
    }

    // =================================================================
    // >>>>> FUN√á√ÉO CORRIGIDA (CORRE√á√ÉO DO SYNTAX ERROR) <<<<<
    // =================================================================
    function mostrarResultadoAnalise(analise){
      const resultadoDiv = document.getElementById('resultadoAnalise');
      if (!resultadoDiv) return;

      const {
        jogo, campeonato, urls,
        coleta_dados, camada1_circunstancial, camada2_estrutural,
        veredito_final, recomendacoes
      } = analise;

      const [mandante, visitante] = (jogo || 'Time A x Time B').split('x').map(t => t.trim());

      const criarTabelaCriterios = (dados, titulo) => {
        if (typeof dados !== 'object' || dados === null) {
          return `<div class="team-analysis"><h4>${titulo}</h4><p class="error">Dados desta camada n√£o encontrados.</p></div>`;
        }
        let html = `<div class="team-analysis"><h4>${titulo}</h4><table class="criteria-table"><thead><tr><th>Crit√©rio</th><th>Nota</th></tr></thead><tbody>`;
        for (const [key, value] of Object.entries(dados)) {
          if (key !== 'total' && value && typeof value.nota !== 'undefined') {
            html += `<tr><td>${key.replace(/_/g, ' ')}</td><td class="${getScoreClass(value.nota)}">${value.nota}/10</td></tr>`;
          }
        }
        html += `</tbody><tfoot><tr><th>Total</th><th>${dados.total || 0}</th></tr></tfoot></table></div>`;
        return html;
      };

      resultadoDiv.innerHTML = `
        <div class="success">
          <h3>‚úÖ An√°lise Conclu√≠da com Sucesso!</h3>
        </div>

        <div class="analysis-section">
          <h2>Veredito Final: ${jogo || 'Jogo n√£o identificado'}</h2>
          <div class="confidence-indicator ${getClasseNivel(veredito_final?.nivel_confianca)}">
            ${veredito_final?.nivel_confianca || 'N/A'} (${veredito_final?.percentual_confianca || 0}%)
          </div>
          <p><strong>Cen√°rio:</strong> ${veredito_final?.cenario_classificacao || 'N/A'}</p>
          <p><strong>An√°lise Resumida:</strong> ${veredito_final?.analise_final || 'N/A'}</p>
          ${(veredito_final?.diretrizes_aplicadas && veredito_final.diretrizes_aplicadas.length > 0)
            ? `<p><strong>Diretrizes Aplicadas:</strong> ${veredito_final.diretrizes_aplicadas.join(', ')}</p>`
            : ''
          }
        </div>

        <div class="analysis-section">
          <h3>üéØ Recomenda√ß√µes Pr√°ticas</h3>
          <div class="recommendations-grid">
            <div class="recommendation-card"><h4>Resultado Prov√°vel</h4><p>${recomendacoes?.resultado_provavel || 'N/A'}</p></div>
            <div class="recommendation-card"><h4>Placares Prov√°veis</h4><p>${recomendacoes?.placares_provaveis?.join(' | ') || 'N/A'}</p></div>
            <div class="recommendation-card"><h4>Mercado de Gols</h4><p>${recomendacoes?.mercado_gols || 'N/A'}</p></div>
            <div class="recommendation-card"><h4>Ambos Marcam (BTTS)</h4><p>${recomendacoes?.ambos_marcam || 'N/A'}</p></div>
            <div class="recommendation-card"><h4>Loteca</h4><p>${recomendacoes?.loteca || 'N/A'}</p></div>
          </div>
        </div>

        <button class="collapsible">Ver An√°lise de Dupla Camada (Detalhes)</button>
        <div class="collapsible-content">
          <div class="analysis-section">
            <h3>üìä Camada 1: For√ßa Circunstancial</h3>
            <div class="layer-analysis">
              ${criarTabelaCriterios(camada1_circunstancial?.mandante, `Mandante: ${mandante}`)}
              ${criarTabelaCriterios(camada1_circunstancial?.visitante, `Visitante: ${visitante}`)}
            </div>
            <p style="text-align:center; margin-top:15px;"><strong>Sem√°foro do Jogo:</strong> ${camada1_circunstancial?.semaforo_jogo || 'N/A'}</p>
          </div>

          <div class="analysis-section">
            <h3>üèóÔ∏è Camada 2: For√ßa Estrutural</h3>
             <div class="layer-analysis">
              ${criarTabelaCriterios(camada2_estrutural?.mandante, `Mandante: ${mandante}`)}
              ${criarTabelaCriterios(camada2_estrutural?.visitante, `Visitante: ${visitante}`)}
            </div>
          </div>
        </div>

        <button class="collapsible">Ver Dados Coletados (Pr√©-An√°lise)</button>
        <div class="collapsible-content">
           <div class="analysis-section">
             <p><strong>Posi√ß√£o na Tabela:</strong> ${coleta_dados?.posicao_tabela || 'N/A'}</p>
             <p><strong>√öltimos Jogos:</strong> ${coleta_dados?.ultimos_jogos || 'N/A'}</p>
             <p><strong>Desfalques:</strong> ${coleta_dados?.desfalques || 'N/A'}</p>
             <p><strong>Clima Interno:</strong> ${coleta_dados?.clima_interno || 'N/A'}</p>
             <p><strong>Hist√≥rico de Confrontos:</strong> ${coleta_dados?.historico_confrontos || 'N/A'}</p>
             <p><strong>Log√≠stica:</strong> ${coleta_dados?.logistica || 'N/A'}</p>
             
             <!-- LINHA CORRIGIDA ABAIXO -->
             // Linha CORRIGIDA
<p><strong>Fontes (URLs):</strong> ${(urls || []).map(u => `<a href="${u}" target="_blank">${u}</a>`).join('  
') || 'N/A'}</p>

           </div>
        </div>
      `;

      inicializarCollapsibles();
    }

    function getScoreClass(nota){
      if(nota === undefined || nota === null) return '';
      if(nota >= 8) return 'score-high';
      if(nota >= 6) return 'score-medium';
      return 'score-low';
    }

    async function carregarHistorico(){
      try{
        const filtro = document.getElementById('filtroNivel').value;
        let query = supabase.from('analises_regua3').select('*').order('created_at',{ascending:false});

        if (filtro) {
          query = query.like('nivel_confianca', `%${filtro}%`);
        }

        const { data: analises, error } = await query;
        if (error) {
          console.error('Erro ao buscar hist√≥rico:', error);
          document.querySelector('#historicoCompleto tbody').innerHTML = `<tr><td colspan="9" class="error">Falha ao carregar o hist√≥rico.</td></tr>`;
          return;
        }
        atualizarTabelaHistorico(analises || []);
      }catch(e){
        console.error('Erro cr√≠tico ao carregar hist√≥rico:', e);
        document.querySelector('#historicoCompleto tbody').innerHTML = `<tr><td colspan="9" class="error">Ocorreu um erro inesperado ao processar o hist√≥rico.</td></tr>`;
      }
    }

    // =================================================================
    // >>>>> FUN√á√ÉO CORRIGIDA PARA EVITAR TRAVAMENTO (ROBUSTA) <<<<<
    // =================================================================
    function atualizarTabelaHistorico(analises){
      const tbody = document.querySelector('#historicoCompleto tbody');
      tbody.innerHTML='';
      if (!analises || analises.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Nenhuma an√°lise encontrada.</td></tr>';
        return;
      }
      analises.forEach(a=>{
        const row = tbody.insertRow();
        // ---- CORRE√á√ÉO DE ROBUSTEZ: Adicionado '|| "-"' para todos os campos para evitar 'null' ou 'undefined' na tela ----
        row.innerHTML = `
          <td>${a.jogo || '-'}</td>
          <td>${a.campeonato || '-'}</td>
          <td><span class="confidence-indicator ${getClasseNivel(a.nivel_confianca)}">${a.nivel_confianca || '-'}</span></td>
          <td>${a.cenario_classificacao || '-'}</td>
          <td>${a.percentual_confianca !== null ? a.percentual_confianca + '%' : '-'}</td>
          <td>${a.previsao_regua || '-'}</td>
          <td>${a.resultado_real || 'Pendente'}</td>
          <td>${a.acerto || 'Pendente'}</td>
          <td><button class="btn" style="padding: 8px 12px;" onclick="verDetalhes('${a.id}')">Detalhes</button></td>`;
      });
    }

    function filtrarHistorico(){
      carregarHistorico();
    }

    async function verDetalhes(id){
      try {
        const { data, error } = await supabase
          .from('analises_regua3')
          .select('*')
          .eq('id', id)
          .single();

        if (error) {
          throw new Error('Erro ao buscar detalhes da an√°lise: ' + error.message);
        }

        // Tenta fazer o parse dos dados JSON. Se falhar, o bloco catch vai pegar.
        const analiseCompleta = {
          ...data,
          coleta_dados: JSON.parse(data.coleta_dados || '{}'),
          camada1_circunstancial: JSON.parse(data.camada1_circunstancial || '{}'),
          camada2_estrutural: JSON.parse(data.camada2_estrutural || '{}'),
          veredito_final: JSON.parse(data.veredito_final || '{}'),
          recomendacoes: JSON.parse(data.recomendacoes || '{}'),
        };

        showTab('nova-analise');
        document.getElementById('analysisSteps').style.display = 'none';
        document.getElementById('novaAnaliseForm').style.display = 'none';
        
        const resultadoDiv = document.getElementById('resultadoAnalise');
        resultadoDiv.innerHTML = `<h2>Detalhes da An√°lise Salva</h2>`;
        mostrarResultadoAnalise(analiseCompleta);

        resultadoDiv.innerHTML += `  
<button class="btn btn-outline" onclick="resetNovaAnaliseView()">Fazer Nova An√°lise</button>`;

      } catch (e) {
        console.error("Erro ao processar detalhes da an√°lise:", e);
        alert("N√£o foi poss√≠vel carregar os detalhes desta an√°lise. O registro pode estar corrompido. Verifique o console para mais informa√ß√µes.");
        // Leva para a aba de an√°lise e mostra um erro l√°
        showTab('nova-analise');
        const resultadoDiv = document.getElementById('resultadoAnalise');
        resultadoDiv.innerHTML = `<div class="error"><h3>Erro ao carregar detalhes</h3><p>${e.message}</p><p>Este registro de an√°lise pode estar corrompido no banco de dados.</p></div>
          
<button class="btn btn-outline" onclick="resetNovaAnaliseView()">Voltar</button>`;
      }
    }

    function resetNovaAnaliseView() {
      document.getElementById('novaAnaliseForm').style.display = 'block';
      document.getElementById('resultadoAnalise').innerHTML = '';
      document.getElementById('analysisSteps').style.display = 'none';
      document.getElementById('jogoInput').value = '';
      document.getElementById('campeonatoInput').value = '';
      document.getElementById('url1').value = '';
      document.getElementById('url2').value = '';
      document.getElementById('url3').value = '';
      
      for(let i = 1; i <= 6; i++) {
        updateStep(`step${i}`, 'pending');
      }
    }

  </script>
</body>
</html>
