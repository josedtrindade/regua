<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©gua 3.0 - An√°lise de Dupla Camada com OpenAI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover {
            background: #5a6fd8;
            color: white;
        }
        
        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .url-inputs {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .confidence-indicator {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .verde-escuro {
            background: #1e7e34;
            color: white;
        }
        
        .verde-claro {
            background: #28a745;
            color: white;
        }
        
        .amarelo {
            background: #ffc107;
            color: #333;
        }
        
        .laranja {
            background: #fd7e14;
            color: white;
        }
        
        .vermelho {
            background: #dc3545;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .connection-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .ai-status {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .ai-indicator {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .ai-active {
            background: #d4edda;
            color: #155724;
        }
        
        .ai-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .analysis-steps {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 5px;
        }
        
        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .step-pending {
            background: #6c757d;
            color: white;
        }
        
        .step-active {
            background: #007bff;
            color: white;
        }
        
        .step-complete {
            background: #28a745;
            color: white;
        }
        
        .step-error {
            background: #dc3545;
            color: white;
        }
        
        .security-badge {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .analysis-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .layer-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .team-analysis {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .criteria-table {
            width: 100%;
            margin-top: 10px;
        }
        
        .criteria-table th,
        .criteria-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .score-high {
            background: #d4edda;
            color: #155724;
        }
        
        .score-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .score-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .recommendation-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .recommendation-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .collapsible {
            background: #f1f1f1;
            color: #444;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            font-weight: 600;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .collapsible:hover {
            background: #ddd;
        }
        
        .collapsible.active {
            background: #667eea;
            color: white;
        }
        
        .collapsible-content {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background: white;
            border-radius: 0 0 5px 5px;
        }
        
        .collapsible-content.active {
            padding: 15px;
            max-height: 1000px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öΩ R√©gua 3.0 - An√°lise de Dupla Camada</h1>
            <p>Sistema Inteligente de An√°lise de Futebol com Metodologia Completa <span class="security-badge">üîí SEGURO</span></p>
        </div>
        
        <div id="connectionStatus" class="connection-status disconnected">
            üîÑ Conectando ao banco de dados...
        </div>
        
        <div class="ai-status">
            <div id="openaiStatus" class="ai-indicator ai-active">üß† OpenAI GPT-4: Ativo e Seguro</div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('nova-analise')">‚ûï Nova An√°lise</button>
            <button class="tab" onclick="showTab('historico')">üìã Hist√≥rico</button>
            <button class="tab" onclick="showTab('metodologia')">üìö Metodologia</button>
            <button class="tab" onclick="showTab('sobre')">‚ÑπÔ∏è Sobre</button>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2>üìä Performance da R√©gua 3.0</h2>
                
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <h3 id="totalJogos">-</h3>
                        <p>Total de Jogos</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="taxaAcerto">-</h3>
                        <p>Taxa de Acerto Geral</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="verdeEscuroAcerto">-</h3>
                        <p>Verde Escuro</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="verdeClaroAcerto">-</h3>
                        <p>Verde Claro</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="amareloAcerto">-</h3>
                        <p>Amarelo</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="laranjaAcerto">-</h3>
                        <p>Laranja</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
                
                <div class="table-container">
                    <h3>üéØ √öltimas An√°lises</h3>
                    <table id="ultimasAnalises">
                        <thead>
                            <tr>
                                <th>Jogo</th>
                                <th>N√≠vel</th>
                                <th>Cen√°rio</th>
                                <th>Previs√£o</th>
                                <th>Resultado</th>
                                <th>Acerto</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Nova An√°lise Tab -->
            <div id="nova-analise" class="tab-content">
                <h2>‚ûï Nova An√°lise com R√©gua 3.0</h2>
                
                <div class="success">
                    <h4>üîí Sistema Seguro</h4>
                    <p>Sua chave OpenAI est√° protegida no servidor. A an√°lise segue fielmente a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada" com 12 diretrizes espec√≠ficas.</p>
                </div>
                
                <form id="novaAnaliseForm">
                    <div class="form-group">
                        <label>üèÜ Jogo (ex: Flamengo x Palmeiras)</label>
                        <input type="text" id="jogoInput" placeholder="Time Mandante x Time Visitante" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üèÜ Campeonato</label>
                        <input type="text" id="campeonatoInput" placeholder="Ex: Campeonato Brasileiro - S√©rie A" required>
                    </div>
                    
                    <div class="url-inputs">
                        <div class="form-group">
                            <label>üì∞ URL Not√≠cia 1 (obrigat√≥ria)</label>
                            <input type="url" id="url1" placeholder="https://globoesporte.globo.com/..." required>
                        </div>
                        <div class="form-group">
                            <label>üì∞ URL Not√≠cia 2 (opcional)</label>
                            <input type="url" id="url2" placeholder="https://espn.com.br/...">
                        </div>
                        <div class="form-group">
                            <label>üì∞ URL Not√≠cia 3 (opcional)</label>
                            <input type="url" id="url3" placeholder="https://lance.com.br/...">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="analisarBtn">
                        üß† Analisar com R√©gua 3.0
                    </button>
                </form>
                
                <div id="analysisSteps" class="analysis-steps" style="display: none;">
                    <h4>üîÑ Progresso da An√°lise:</h4>
                    <div class="step" id="step1">
                        <div class="step-icon step-pending">1</div>
                        <span>Coletando dados das URLs...</span>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-icon step-pending">2</div>
                        <span>Aplicando as 12 diretrizes de pondera√ß√£o...</span>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-icon step-pending">3</div>
                        <span>Executando Camada 1 (9 crit√©rios circunstanciais)...</span>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-icon step-pending">4</div>
                        <span>Executando Camada 2 (4 crit√©rios estruturais)...</span>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-icon step-pending">5</div>
                        <span>Gerando veredito final e recomenda√ß√µes...</span>
                    </div>
                    <div class="step" id="step6">
                        <div class="step-icon step-pending">6</div>
                        <span>Salvando an√°lise completa...</span>
                    </div>
                </div>
                
                <div id="resultadoAnalise" style="margin-top: 30px;"></div>
            </div>
            
            <!-- Hist√≥rico Tab -->
            <div id="historico" class="tab-content">
                <h2>üìã Hist√≥rico Completo</h2>
                
                <div class="form-group">
                    <label>üîç Filtrar por N√≠vel</label>
                    <select id="filtroNivel" onchange="filtrarHistorico()">
                        <option value="">Todos os n√≠veis</option>
                        <option value="Verde Escuro">Verde Escuro (90-100%)</option>
                        <option value="Verde Claro">Verde Claro (80-89%)</option>
                        <option value="Amarelo">Amarelo (70-79%)</option>
                        <option value="Laranja">Laranja (60-69%)</option>
                        <option value="Vermelho">Vermelho (<60%)</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table id="historicoCompleto">
                        <thead>
                            <tr>
                                <th>Jogo</th>
                                <th>Campeonato</th>
                                <th>N√≠vel</th>
                                <th>Cen√°rio</th>
                                <th>Confian√ßa %</th>
                                <th>Previs√£o</th>
                                <th>Resultado</th>
                                <th>Acerto</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Metodologia Tab -->
            <div id="metodologia" class="tab-content">
                <h2>üìö Metodologia R√©gua 3.0</h2>
                
                <div class="analysis-section">
                    <h3>üéØ Vis√£o Geral</h3>
                    <p>A R√©gua 3.0 √© um sistema de an√°lise de futebol baseado em <strong>Dupla Camada</strong> com <strong>12 diretrizes espec√≠ficas</strong> de pondera√ß√£o para cen√°rios do futebol brasileiro e internacional.</p>
                </div>
                
                <button class="collapsible">üìã 12 Diretrizes de Pondera√ß√£o</button>
                <div class="collapsible-content">
                    <ol>
                        <li><strong>Regra do Desgaste Log√≠stico:</strong> Equipes com jogos decisivos no meio da semana</li>
                        <li><strong>Regra do Cl√°ssico de Desespero:</strong> Cl√°ssicos com times em situa√ß√µes extremas</li>
                        <li><strong>Regra do Fator Clim√°tico/Campo:</strong> Condi√ß√µes extremas de clima ou gramado</li>
                        <li><strong>Regra do Le√£o Ferido:</strong> Times qualificados em sequ√™ncia negativa</li>
                        <li><strong>Alerta de Zebra por Calamidade:</strong> Desfalques massivos vs advers√°rio sem press√£o</li>
                        <li><strong>Regra da Ressaca Heroica:</strong> Efeito p√≥s-gl√≥ria em grandes feitos</li>
                        <li><strong>Regra da Revers√£o √† M√©dia:</strong> Despertar do gigante adormecido</li>
                        <li><strong>Times de Meio de Tabela x Mandantes Desesperados:</strong> Neutraliza√ß√£o do favoritismo</li>
                        <li><strong>Empate na Ida:</strong> Rebaixamento autom√°tico de n√≠vel</li>
                        <li><strong>O Miolo Perigos√≠ssimo:</strong> Diferen√ßa m√≠nima de pontos (0-2)</li>
                        <li><strong>Alerta de Zebra (Verde Claro):</strong> Verifica√ß√£o secund√°ria de risco</li>
                        <li><strong>Volatilidade Amarela:</strong> Zona de alta imprevisibilidade</li>
                    </ol>
                </div>
                
                <button class="collapsible">üîç Camada 1: For√ßa Circunstancial (9 Crit√©rios)</button>
                <div class="collapsible-content">
                    <table class="criteria-table">
                        <tr>
                            <th>Crit√©rio</th>
                            <th>Descri√ß√£o</th>
                            <th>Peso</th>
                        </tr>
                        <tr>
                            <td>B. Motiva√ß√£o</td>
                            <td>Import√¢ncia do jogo, rivalidade, objetivos</td>
                            <td>Alto</td>
                        </tr>
                        <tr>
                            <td>C. Desfalques</td>
                            <td>Aus√™ncias confirmadas/prov√°veis</td>
                            <td>Alto</td>
                        </tr>
                        <tr>
                            <td>D. Psicol√≥gico</td>
                            <td>Clima recente, confian√ßa, press√£o</td>
                            <td>Alto</td>
                        </tr>
                        <tr>
                            <td>E. Momento na Tabela</td>
                            <td>Classifica√ß√£o e necessidade do resultado</td>
                            <td>M√©dio</td>
                        </tr>
                        <tr>
                            <td>F. Mando de Campo</td>
                            <td>Est√°dio, torcida, condi√ß√µes locais</td>
                            <td>M√©dio</td>
                        </tr>
                        <tr>
                            <td>G. Elenco/Estrat√©gia</td>
                            <td>Encaixe t√°tico para o confronto</td>
                            <td>Alto</td>
                        </tr>
                        <tr>
                            <td>H. Forma Recente</td>
                            <td>Performance dos √∫ltimos jogos</td>
                            <td>Alto</td>
                        </tr>
                        <tr>
                            <td>I. Confronto Direto</td>
                            <td>Hist√≥rico recente entre as equipes</td>
                            <td>M√©dio</td>
                        </tr>
                        <tr>
                            <td>J. Log√≠stica/Fadiga</td>
                            <td>Sequ√™ncia de jogos e viagens</td>
                            <td>M√©dio</td>
                        </tr>
                    </table>
                </div>
                
                <button class="collapsible">üèóÔ∏è Camada 2: For√ßa Estrutural (4 Crit√©rios Ponderados)</button>
                <div class="collapsible-content">
                    <table class="criteria-table">
                        <tr>
                            <th>Crit√©rio</th>
                            <th>Descri√ß√£o</th>
                            <th>Peso</th>
                        </tr>
                        <tr>
                            <td>1. Qualidade Estrutural</td>
                            <td>For√ßa, profundidade e poder de decis√£o do plantel</td>
                            <td>3x</td>
                        </tr>
                        <tr>
                            <td>2. Consist√™ncia T√°tica</td>
                            <td>Estabilidade de performance e solidez do modelo</td>
                            <td>2x</td>
                        </tr>
                        <tr>
                            <td>3. Resili√™ncia Mental</td>
                            <td>Hist√≥rico de rea√ß√£o √† adversidade e press√£o</td>
                            <td>2x</td>
                        </tr>
                        <tr>
                            <td>4. Fator T√©cnico/Gerencial</td>
                            <td>Qualidade do treinador e organiza√ß√£o</td>
                            <td>1x</td>
                        </tr>
                    </table>
                </div>
                
                <button class="collapsible">üé® Sistema de Cores de Confian√ßa</button>
                <div class="collapsible-content">
                    <div class="confidence-indicator verde-escuro">üü¢ Verde Escuro (90-100%) - Favoritismo consolidado, cen√°rio limpo</div>
                    <div class="confidence-indicator verde-claro">üü¢ Verde Claro (80-89%) - Favoritismo s√≥lido, pequenas incertezas</div>
                    <div class="confidence-indicator amarelo">üü° Amarelo (70-79%) - Jogo inst√°vel, favoritismo fr√°gil</div>
                    <div class="confidence-indicator laranja">üü† Laranja (60-69%) - Alto risco, fatores de zebra ativos</div>
                    <div class="confidence-indicator vermelho">üî¥ Vermelho (<60%) - Jogo imponder√°vel, m√°xima imprevisibilidade</div>
                </div>
            </div>
            
            <!-- Sobre Tab -->
            <div id="sobre" class="tab-content">
                <h2>‚ÑπÔ∏è Sobre a R√©gua 3.0</h2>
                
                <div style="line-height: 1.6;">
                    <h3>üéØ Metodologia Completa</h3>
                    <p>Sistema de an√°lise de futebol baseado em <strong>Dupla Camada</strong> com metodologia cient√≠fica:</p>
                    <ul style="margin: 15px 0 15px 30px;">
                        <li><strong>12 Diretrizes Espec√≠ficas:</strong> Regras de pondera√ß√£o para cen√°rios √∫nicos</li>
                        <li><strong>Camada 1:</strong> 9 crit√©rios circunstanciais (0-10 cada)</li>
                        <li><strong>Camada 2:</strong> 4 crit√©rios estruturais ponderados</li>
                        <li><strong>Sistema de Cores:</strong> 5 n√≠veis de confian√ßa</li>
                        <li><strong>Fluxo Obrigat√≥rio:</strong> Coleta ‚Üí An√°lise ‚Üí Veredito ‚Üí Recomenda√ß√µes</li>
                    </ul>
                    
                    <h3>üìä N√≠veis de Confian√ßa Detalhados</h3>
                    <div class="confidence-indicator verde-escuro">üü¢ Verde Escuro (90-100%) ‚Üí Apostar seco / coluna √∫nica</div>
                    <div class="confidence-indicator verde-claro">üü¢ Verde Claro (80-89%) ‚Üí Recomenda√ß√£o: 1 ou 2, seguran√ßa 1X/2X</div>
                    <div class="confidence-indicator amarelo">üü° Amarelo (70-79%) ‚Üí Duplo obrigat√≥rio (1X ou X2)</div>
                    <div class="confidence-indicator laranja">üü† Laranja (60-69%) ‚Üí Duplo aberto (12) ou Triplo</div>
                    <div class="confidence-indicator vermelho">üî¥ Vermelho (<60%) ‚Üí Triplo (1X2)</div>
                    
                    <h3>üß† Integra√ß√£o com OpenAI GPT-4</h3>
                    <p>O sistema utiliza OpenAI GPT-4 com configura√ß√£o otimizada:</p>
                    <ul style="margin: 15px 0 15px 30px;">
                        <li><strong>Modelo:</strong> GPT-4 (mais avan√ßado que GPT-3.5)</li>
                        <li><strong>Temperature:</strong> 0 (m√°xima precis√£o)</li>
                        <li><strong>Max Tokens:</strong> 4096+ (an√°lises completas)</li>
                        <li><strong>System + User Messages:</strong> Prompt estruturado</li>
                        <li><strong>üîí Seguran√ßa:</strong> Chave protegida no servidor</li>
                    </ul>
                    
                    <h3>üîÑ Processo Completo de An√°lise</h3>
                    <ol style="margin: 15px 0 15px 30px;">
                        <li><strong>Coleta de Dados:</strong> Extra√ß√£o de conte√∫do das URLs</li>
                        <li><strong>Aplica√ß√£o das 12 Diretrizes:</strong> Pondera√ß√£o de cen√°rios espec√≠ficos</li>
                        <li><strong>Camada 1:</strong> Avalia√ß√£o dos 9 crit√©rios circunstanciais</li>
                        <li><strong>Camada 2:</strong> Avalia√ß√£o dos 4 crit√©rios estruturais ponderados</li>
                        <li><strong>Veredito Final:</strong> An√°lise de conflito e classifica√ß√£o de cen√°rio</li>
                        <li><strong>Recomenda√ß√µes:</strong> Para todos os mercados (resultado, gols, ambos marcam, loteca)</li>
                    </ol>
                    
                    <h3>üõ°Ô∏è Seguran√ßa e Confiabilidade</h3>
                    <p>Sua chave OpenAI fica protegida no servidor atrav√©s de Environment Variables. O sistema segue fielmente a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada" sem simplifica√ß√µes.</p>
                    
                    <h3>üìà Melhorias Implementadas</h3>
                    <ul style="margin: 15px 0 15px 30px;">
                        <li>‚úÖ Prompt completo com todas as 12 diretrizes</li>
                        <li>‚úÖ Metodologia de dupla camada implementada</li>
                        <li>‚úÖ Sistema de cores de confian√ßa (5 n√≠veis)</li>
                        <li>‚úÖ Fluxo de trabalho obrigat√≥rio</li>
                        <li>‚úÖ JSON estruturado para an√°lise completa</li>
                        <li>‚úÖ Recomenda√ß√µes para todos os mercados</li>
                        <li>‚úÖ Interface adaptada para an√°lise detalhada</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://shjjweviipblcjukvxry.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNoamp3ZXZpaXBibGNqdWt2eHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjY1NDMsImV4cCI6MjA3MjQ0MjU0M30.LJmmMKDASQfvDo4D_S-tbHDUh2jUb2VuFwl3EqrLBas';
        
        let supabase = null;
        
        // Inicializar app
        document.addEventListener('DOMContentLoaded', function() {
            inicializarSupabase();
            carregarDashboard();
            inicializarCollapsibles();
        });
        
        function inicializarSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                document.getElementById('connectionStatus').innerHTML = '‚úÖ Conectado ao banco de dados';
                document.getElementById('connectionStatus').className = 'connection-status connected';
            } catch (error) {
                console.error('Erro ao conectar:', error);
                document.getElementById('connectionStatus').innerHTML = '‚ùå Erro na conex√£o com banco';
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
            }
        }
        
        function inicializarCollapsibles() {
            const collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    content.classList.toggle('active');
                });
            });
        }
        
        // Gerenciamento de tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                carregarDashboard();
            } else if (tabName === 'historico') {
                carregarHistorico();
            }
        }
        
        // Dashboard
        async function carregarDashboard() {
            if (!supabase) return;
            
            try {
                const { data: analises, error } = await supabase
                    .from('analises_regua3')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao buscar an√°lises:', error);
                    return;
                }
                
                const stats = calcularEstatisticas(analises || []);
                atualizarDashboard(stats);
                criarGrafico(stats);
                
                const ultimasAnalises = (analises || []).slice(0, 10);
                atualizarTabelaUltimas(ultimasAnalises);
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }
        
        function calcularEstatisticas(analises) {
            const stats = {
                total: analises.length,
                acertos: 0,
                verdeEscuro: { total: 0, acertos: 0 },
                verdeClaro: { total: 0, acertos: 0 },
                amarelo: { total: 0, acertos: 0 },
                laranja: { total: 0, acertos: 0 },
                vermelho: { total: 0, acertos: 0 }
            };
            
            analises.forEach(analise => {
                const acertou = analise.acerto && (analise.acerto.includes('‚úÖ') || analise.acerto.includes('Pleno'));
                if (acertou) stats.acertos++;
                
                const nivel = analise.nivel_confianca || '';
                if (nivel.includes('Verde Escuro')) {
                    stats.verdeEscuro.total++;
                    if (acertou) stats.verdeEscuro.acertos++;
                } else if (nivel.includes('Verde Claro')) {
                    stats.verdeClaro.total++;
                    if (acertou) stats.verdeClaro.acertos++;
                } else if (nivel.includes('Amarelo')) {
                    stats.amarelo.total++;
                    if (acertou) stats.amarelo.acertos++;
                } else if (nivel.includes('Laranja')) {
                    stats.laranja.total++;
                    if (acertou) stats.laranja.acertos++;
                } else if (nivel.includes('Vermelho')) {
                    stats.vermelho.total++;
                    if (acertou) stats.vermelho.acertos++;
                }
            });
            
            return stats;
        }
        
        function atualizarDashboard(stats) {
            document.getElementById('totalJogos').textContent = stats.total;
            document.getElementById('taxaAcerto').textContent = 
                stats.total > 0 ? Math.round((stats.acertos / stats.total) * 100) + '%' : '0%';
            document.getElementById('verdeEscuroAcerto').textContent = 
                stats.verdeEscuro.total > 0 ? Math.round((stats.verdeEscuro.acertos / stats.verdeEscuro.total) * 100) + '%' : '0%';
            document.getElementById('verdeClaroAcerto').textContent = 
                stats.verdeClaro.total > 0 ? Math.round((stats.verdeClaro.acertos / stats.verdeClaro.total) * 100) + '%' : '0%';
            document.getElementById('amareloAcerto').textContent = 
                stats.amarelo.total > 0 ? Math.round((stats.amarelo.acertos / stats.amarelo.total) * 100) + '%' : '0%';
            document.getElementById('laranjaAcerto').textContent = 
                stats.laranja.total > 0 ? Math.round((stats.laranja.acertos / stats.laranja.total) * 100) + '%' : '0%';
        }
        
        function criarGrafico(stats) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Verde Escuro', 'Verde Claro', 'Amarelo', 'Laranja', 'Vermelho'],
                    datasets: [{
                        label: 'Taxa de Acerto (%)',
                        data: [
                            stats.verdeEscuro.total > 0 ? Math.round((stats.verdeEscuro.acertos / stats.verdeEscuro.total) * 100) : 0,
                            stats.verdeClaro.total > 0 ? Math.round((stats.verdeClaro.acertos / stats.verdeClaro.total) * 100) : 0,
                            stats.amarelo.total > 0 ? Math.round((stats.amarelo.acertos / stats.amarelo.total) * 100) : 0,
                            stats.laranja.total > 0 ? Math.round((stats.laranja.acertos / stats.laranja.total) * 100) : 0,
                            stats.vermelho.total > 0 ? Math.round((stats.vermelho.acertos / stats.vermelho.total) * 100) : 0
                        ],
                        backgroundColor: ['#1e7e34', '#28a745', '#ffc107', '#fd7e14', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function atualizarTabelaUltimas(analises) {
            const tbody = document.querySelector('#ultimasAnalises tbody');
            tbody.innerHTML = '';
            
            analises.forEach(analise => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${analise.jogo || '-'}</td>
                    <td><span class="confidence-indicator ${getClasseNivel(analise.nivel_confianca || '')}">${analise.nivel_confianca || '-'}</span></td>
                    <td>${analise.cenario_classificacao || '-'}</td>
                    <td>${analise.previsao_regua || '-'}</td>
                    <td>${analise.resultado_real || '-'}</td>
                    <td>${analise.acerto || '-'}</td>
                `;
            });
        }
        
        function getClasseNivel(nivel) {
            if (nivel.includes('Verde Escuro')) return 'verde-escuro';
            if (nivel.includes('Verde Claro')) return 'verde-claro';
            if (nivel.includes('Amarelo')) return 'amarelo';
            if (nivel.includes('Laranja')) return 'laranja';
            if (nivel.includes('Vermelho')) return 'vermelho';
            return '';
        }
        
        // Nova An√°lise com R√©gua 3.0 Completa
        document.getElementById('novaAnaliseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!supabase) {
                alert('‚ùå Erro na conex√£o com banco de dados!');
                return;
            }
            
            const jogo = document.getElementById('jogoInput').value;
            const campeonato = document.getElementById('campeonatoInput').value;
            const urls = [
                document.getElementById('url1').value,
                document.getElementById('url2').value,
                document.getElementById('url3').value
            ].filter(url => url.trim());
            
            if (urls.length === 0) {
                alert('‚ùå Adicione pelo menos uma URL de not√≠cia!');
                return;
            }
            
            // Mostrar progresso
            document.getElementById('analysisSteps').style.display = 'block';
            document.getElementById('resultadoAnalise').innerHTML = '';
            document.getElementById('analisarBtn').disabled = true;
            
            try {
                await analisarComRegua3(jogo, campeonato, urls);
            } catch (error) {
                console.error('Erro na an√°lise:', error);
                document.getElementById('resultadoAnalise').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro na An√°lise</h3>
                        <p>${error.message}</p>
                        <p><small>Verifique se a chave OpenAI est√° configurada corretamente.</small></p>
                    </div>
                `;
            } finally {
                document.getElementById('analisarBtn').disabled = false;
            }
        });
        
        async function analisarComRegua3(jogo, campeonato, urls) {
            // Passo 1: Coletar dados
            updateStep('step1', 'active');
            const conteudos = await extrairConteudoURLs(urls);
            updateStep('step1', 'complete');
            
            // Passo 2: Aplicar diretrizes
            updateStep('step2', 'active');
            await new Promise(resolve => setTimeout(resolve, 1000)); // Simular processamento
            updateStep('step2', 'complete');
            
            // Passo 3: Camada 1
            updateStep('step3', 'active');
            await new Promise(resolve => setTimeout(resolve, 1000));
            updateStep('step3', 'complete');
            
            // Passo 4: Camada 2
            updateStep('step4', 'active');
            await new Promise(resolve => setTimeout(resolve, 1000));
            updateStep('step4', 'complete');
            
            // Passo 5: An√°lise com OpenAI
            updateStep('step5', 'active');
            const analiseCompleta = await analisarConteudoComRegua3(jogo, campeonato, conteudos);
            updateStep('step5', 'complete');
            
            // Passo 6: Salvar no banco
            updateStep('step6', 'active');
            await salvarAnaliseNoBanco(analiseCompleta);
            updateStep('step6', 'complete');
            
            // Mostrar resultado
            mostrarResultadoAnalise(analiseCompleta);
            carregarDashboard();
        }
        
        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            const icon = step.querySelector('.step-icon');
            
            icon.className = `step-icon step-${status}`;
            
            if (status === 'complete') {
                icon.innerHTML = '‚úì';
            } else if (status === 'error') {
                icon.innerHTML = '‚úó';
            }
        }
        
        async function extrairConteudoURLs(urls) {
            const conteudos = [];
            
            for (const url of urls) {
                try {
                    // Usar um proxy CORS ou servi√ßo de extra√ß√£o
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    
                    // Extrair texto relevante (simplificado)
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.contents, 'text/html');
                    const texto = doc.body.innerText.substring(0, 3000); // Primeiros 3000 caracteres
                    
                    conteudos.push({
                        url: url,
                        conteudo: texto
                    });
                } catch (error) {
                    console.error(`Erro ao extrair ${url}:`, error);
                    conteudos.push({
                        url: url,
                        conteudo: 'Erro ao extrair conte√∫do'
                    });
                }
            }
            
            return conteudos;
        }
        
        async function analisarConteudoComRegua3(jogo, campeonato, conteudos) {
            // Prompt completo da R√©gua 3.0
            const promptCompleto = `Voc√™ √© um Analista de Futebol S√™nior, aut√¥nomo e proativo. Sua tarefa √© realizar uma an√°lise completa de uma partida de futebol usando a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada".

DADOS DA PARTIDA:
Campeonato: ${campeonato}
Partida: ${jogo}

DIRETRIZES DE AN√ÅLISE AVAN√áADA (REGRAS DE PONDERA√á√ÉO):
Antes de iniciar a avalia√ß√£o, voc√™ deve aplicar as seguintes diretrizes de pondera√ß√£o para cen√°rios espec√≠ficos do futebol brasileiro ou internacional. Elas se sobrep√µem √† avalia√ß√£o padr√£o para garantir uma an√°lise mais precisa e sutil.

Diretriz 1: "Regra do Desgaste Log√≠stico" (An√°logo √† Vantagem Extrema)
Cen√°rio: Se uma equipe (especialmente a visitante) jogou uma partida decisiva de mata-mata no meio da semana, envolvendo uma viagem longa (ex: jogo da Libertadores na Col√¥mbia na quarta, e jogo do Brasileir√£o em Fortaleza no s√°bado).
A√ß√£o: O crit√©rio J (Log√≠stica/Fadiga) desta equipe deve ser travado em uma nota muito baixa (‚â§ 3/10). O crit√©rio C (Desfalques) deve ser avaliado com a premissa de que o time provavelmente ser√° misto ou reserva. A an√°lise deve explicitamente considerar um jogo de baixa intensidade por parte desta equipe, aumentando a chance de um resultado surpreendente.

Diretriz 2: "Regra do Cl√°ssico de Desespero" (An√°logo ao Equil√≠brio T√°tico do 0x0)
Cen√°rio: Se a partida √© um cl√°ssico regional onde um time luta na parte de cima da tabela (t√≠tulo/G4) e o outro luta desesperadamente contra o rebaixamento (Z4).
A√ß√£o: O crit√©rio B (Motiva√ß√£o) do time que luta contra o rebaixamento deve receber nota m√°xima (10/10). O crit√©rio D (Psicol√≥gico) do time favorito deve ser analisado com um vi√©s de "risco de complac√™ncia" ou "press√£o da obriga√ß√£o de vencer", enquanto o do time desesperado deve ser visto como "jogando a vida". A an√°lise deve reconhecer que a diferen√ßa t√©cnica entre as equipes √© parcialmente neutralizada por essa carga emocional extrema.

Diretriz 3: "Regra do Fator Clim√°tico/Campo" (An√°logo da Altitude)
Cen√°rio: Se um jogo ocorrer em condi√ß√µes clim√°ticas extremas (ex: calor de 35¬∞C+ ao meio-dia) ou em um gramado comprovadamente ruim e pesado.
A√ß√£o: O crit√©rio F (Mando de Campo) do time da casa deve ser potencializado. Na justificativa do crit√©rio G (Elenco/Estrat√©gia), voc√™ deve explicitamente reduzir o peso da superioridade t√©cnica do time visitante se ele for uma equipe de "toque de bola", explicando que a condi√ß√£o extrema nivela o jogo para um confronto mais f√≠sico e de menor qualidade t√©cnica.

Diretriz 4: Regra do Le√£o Ferido" (An√°logo √† Revers√£o √† M√©dia):
Cen√°rio: Quando uma equipe com elenco de qualidade comprovada (G6/G8 em potencial) entra em uma sequ√™ncia de 3+ jogos sem vencer e joga em casa contra um advers√°rio em boa fase, mas de n√≠vel t√©cnico similar ou ligeiramente inferior.
A√ß√£o Proposta: O crit√©rio F (Mando de Campo) desta equipe deve ser potencializado (nota ‚â• 9). O crit√©rio H (Forma Recente) do advers√°rio (que est√° em boa fase) deve ter seu peso reduzido na an√°lise qualitativa, com a justificativa de que "sequ√™ncias de vit√≥ria s√£o dif√≠ceis de manter fora de casa contra advers√°rios qualificados e pressionados". A an√°lise de gols deve pender para "Acima de 2.5", pois o time da casa jogar√° de forma mais agressiva e exposta para dar uma resposta.

Diretriz 5: Alerta de Zebra por Calamidade" (O Fator Supera√ß√£o):
Cen√°rio: Quando uma equipe (especialmente a mandante) sofre uma crise de desfalques massiva (5+ jogadores importantes fora), mas enfrenta um advers√°rio que n√£o est√° sob o mesmo n√≠vel de press√£o (n√£o √© um jogo de vida ou morte para o visitante).
A√ß√£o Proposta: A an√°lise deve explicitamente classificar o jogo como de "Risco Imponder√°vel". O palpite principal deve ser evitado. A recomenda√ß√£o para a Loteca deve ser, obrigatoriamente, um Triplo (1X2). A an√°lise qualitativa deve destacar que "a l√≥gica anal√≠tica aponta para o visitante, mas o cen√°rio de supera√ß√£o do time da casa torna o jogo imprevis√≠vel e propenso a um resultado chocante".

Diretriz 6: Regra da Ressaca Heroica" (O Efeito P√≥s-Gl√≥ria):
Cen√°rio: Quando uma equipe vem de um grande feito no meio da semana (classifica√ß√£o em mata-mata, vit√≥ria em cl√°ssico, conquista de t√≠tulo) e enfrenta, no fim de semana, um advers√°rio teoricamente mais fraco ou em m√° fase, especialmente fora de casa.
A√ß√£o Proposta:
Reavalia√ß√£o do Crit√©rio D (Psicol√≥gico): A nota n√£o deve ser automaticamente alta. A justificativa deve ser dividida: "A confian√ßa est√° alta, mas h√° um risco significativo de 'ressaca' e relaxamento, o que pode neutralizar o √≠mpeto positivo." A nota deve ser moderada (6/10 ou 7/10), em vez de alta (9/10 ou 10/10).
Potencializa√ß√£o do Risco: Na an√°lise final (Passo 3), o cen√°rio deve ser classificado como de "Risco de Complac√™ncia".
Ajuste na Recomenda√ß√£o de Aposta: A aposta seca no time que vem do "grande feito" deve ser evitada. A recomenda√ß√£o de seguran√ßa deve pender para um Duplo Aberto (12) ou at√© mesmo um Triplo, reconhecendo que o relaxamento do favorito aumenta drasticamente a chance de uma vit√≥ria do azar√£o.

Diretriz 7: Regra da Revers√£o √† M√©dia" (O Despertar do Gigante Adormecido):
Cen√°rio: Quando uma equipe com elenco estruturalmente superior (avaliado com nota ‚â• 8 no Crit√©rio 1) enfrenta um jejum de vit√≥rias prolongado (5+ jogos) contra um advers√°rio de elenco inferior, mas que vive uma boa fase.
A√ß√£o Proposta:
Alerta de Pondera√ß√£o: A an√°lise deve reconhecer que "a probabilidade de uma quebra de padr√£o aumenta a cada jogo". O peso do Crit√©rio H (Forma Recente) deve ser explicitamente reduzido na an√°lise qualitativa.
Valoriza√ß√£o do Elenco: O Crit√©rio 1 (Qualidade Estrutural do Elenco) do time superior deve ser destacado como um "fator latente" que pode se manifestar a qualquer momento.
An√°lise de Risco: O jogo deve ser classificado como de "Alto Risco de Revers√£o √† M√©dia".
Recomenda√ß√£o de Aposta: A aposta seca deve ser evitada a todo custo. A recomenda√ß√£o para a Loteca deve ser, no m√≠nimo, um Duplo Aberto (12), cobrindo a vit√≥ria do favorito da "fase" (CRB) e a vit√≥ria do favorito da "estrutura" (Athletico). Um Triplo √© o mais indicado.

Diretriz 8 ‚Äì Times de Meio de Tabela x Mandantes Desesperados
Conceito: Equipes de meio de tabela (7¬∫ a 12¬∫ lugar) n√£o t√™m for√ßa de imposi√ß√£o suficiente quando enfrentam mandantes desesperados no Z4 em casa.
Nesses cen√°rios, o "fator sobreviv√™ncia" do mandante deve neutralizar o favoritismo do visitante m√©dio, mesmo que o estrutural seja superior.
Aplica√ß√£o por competi√ß√£o:
S√©rie B (obrigat√≥ria): Visitantes posicionados do 7¬∫ lugar para baixo ‚Üí nunca podem receber Verde Escuro ou Verde Claro contra mandante do Z4 em casa.
Cen√°rio deve ser rebaixado no m√≠nimo para Amarelo, sempre incluindo empate como placar prov√°vel (0x0, 1x1, 2x1 Z4).
S√©rie A (aplica√ß√£o parcial): Se o visitante estiver entre 8¬∫ e 12¬∫ ‚Üí regra v√°lida.
Se for G4/G6 ou clube de grande elenco (mesmo em 7¬∫), mant√©m-se a leitura normal.
Ligas Europeias (dispensada): Em geral, times de meio de tabela europeus mant√™m superioridade clara contra Z4.
S√≥ aplicar se houver crise espec√≠fica documentada (ex.: protestos, sal√°rios atrasados, racha interno).

Diretriz 9 - Empate na Ida
Regra: Se o favorito empatar o jogo da ida fora de casa, rebaixar automaticamente um n√≠vel de cor.
Exemplo: Verde Escuro ‚Üí Verde Claro
Exemplo: Verde Claro ‚Üí Amarelo
Exce√ß√£o: N√£o rebaixar se o empate for jogo protocolar ‚Äî isto √©, quando o favorito j√° ganhou a ida por 3+ gols e apenas poupou jogadores na volta.
Justificativa: O empate fora indica que o azar√£o tem competitividade e moral para brigar na volta.
Portanto, mesmo que o favorito mantenha diferen√ßa de pontos suficiente para Verde Escuro, o cen√°rio deixa de ser "limpo" e precisa ser ajustado para refletir o risco.

Diretriz 10 ‚Äì O Miolo Perigos√≠ssimo
Conceito: Quando a diferen√ßa de pontos circunstanciais entre as equipes √© m√≠nima (0 a 2 pontos), o jogo entra no chamado Miolo da R√©gua.
Esse √© o territ√≥rio da imprevisibilidade m√°xima, onde fatores externos (arbitragem, bola parada, erro individual, expuls√£o, press√£o psicol√≥gica) tendem a decidir o resultado.
Aplica√ß√£o:
‚Ä¢ Classifica√ß√£o: Vermelho (<60%) ‚Üí Perigos√≠ssimo.
‚Ä¢ Recomenda√ß√£o oficial: Sempre Triplo (1X2).
‚Ä¢ Vi√©s de placar: n√£o existe vi√©s confi√°vel. Se forem citados cen√°rios de placar (0x0, 1x1, 1x0, 0x1), devem ser entendidos apenas como exemplos poss√≠veis dentro do Triplo, e nunca como tend√™ncia.
‚Ä¢ Hist√≥rico: at√© agora, os registros da retrospectiva mostram que visitantes t√™m se beneficiado com vit√≥rias em detalhes, ainda que os mandantes dominem estat√≠sticas.
Justificativa:
‚Ä¢ O "miolo" √© onde a R√©gua perde capacidade de cravar tend√™ncia, pois o equil√≠brio √© real e absoluto.
‚Ä¢ O mandante pode ter posse e volume, mas o visitante pode vencer com frieza e efici√™ncia.
‚Ä¢ A zebra mora aqui: √© o setor em que mais se observa resultado decidido por lances isolados.

Diretriz 11 ‚Äì Alerta de Zebra (Verde Claro)
Cen√°rio: Quando o jogo for classificado como Verde Claro (80‚Äì89%), ativar o "Alerta de Zebra".
Checklist de Verifica√ß√£o Secund√°ria:
- O favorito costuma golear advers√°rios fechados ou vence com placares magros?
- O visitante possui boa defesa fora de casa ou contra-ataque perigoso?
- O favorito tem desfalques relevantes no setor ofensivo/ criativo?
A√ß√£o:
- Se 2 ou mais respostas indicarem risco ‚Üí rebaixar a confian√ßa para faixa Amarela (~75%).
- Recomenda√ß√£o: mudar de aposta seca para Duplo Aberto (12) ou, no m√≠nimo, Duplo Fechado (1X).
- Mensagem expl√≠cita no veredito: ‚ö†Ô∏è ALERTA DE ZEBRA VERDE CLARO ‚Äì O favoritismo est√° fragilizado.
Ajuste de Pondera√ß√£o:
- Reduzir levemente o peso de F (Mando de Campo).
- Aumentar o peso de H (Forma Recente) do visitante.

Diretriz 12 ‚Äì Volatilidade Amarela
Cen√°rio: Quando o jogo for classificado como Amarelo (70‚Äì79%), entender como Zona da Volatilidade.
Checklist de Potencial Ofensivo do Azar√£o:
- O azar√£o tem m√©dia de gols alta em casa?
- A defesa do favorito √© fr√°gil fora de casa?
- H√° um artilheiro em boa fase no azar√£o?
A√ß√£o:
- Se 2+ respostas forem positivas ‚Üí incluir placares el√°sticos (ex: 2x0, 3x1 para o azar√£o).
- Ajustar mercado de gols para Over 2.5/3.5.
- Alterar nomenclatura: üü° Amarelo Vol√°til ‚Äì Risco de Goleada/Resultado El√°stico.
Integra√ß√£o com Ressaca Heroica (Diretriz 6):
- Se o favorito vem de grande feito ‚Üí automaticamente baixar nota do Psicol√≥gico (D) e Log√≠stica (J).
- Mensagem expl√≠cita no veredito: ‚ö†Ô∏è ALERTA DE RESSACA HEROICA ‚Äì O favoritismo est√° comprometido.

FLUXO DE TRABALHO OBRIGAT√ìRIO:
Fase de Coleta de Dados (Trabalho Interno): Antes de iniciar a an√°lise, realize uma pesquisa interna e/ou externa para coletar os dados contextuais. Voc√™ deve buscar ativamente por:
Posi√ß√£o na tabela e campanha geral.
Resultados dos √∫ltimos 5 jogos de cada equipe.
Not√≠cias recentes sobre desfalques confirmados ou prov√°veis (les√µes, suspens√µes).
Clima interno dos clubes (crise, euforia, press√£o).
Hist√≥rico recente de confrontos diretos.
Informa√ß√µes sobre log√≠stica (sequ√™ncia de jogos, viagens recentes).

METODOLOGIA: R√©gua 3.0 - An√°lise de Dupla Camada

PASSO 1: AN√ÅLISE DA CAMADA 1 - FOR√áA CIRCUNSTANCIAL (R√âGUA 2.3)
Com base nos dados que voc√™ coletou, avalie cada time de 0 a 10 nos seguintes crit√©rios, justificando cada nota com as informa√ß√µes encontradas.
B. Motiva√ß√£o: (Baseado na import√¢ncia do jogo, rivalidade, objetivos).
C. Desfalques: (Baseado nas not√≠cias de aus√™ncias confirmadas/prov√°veis).
D. Psicol√≥gico: (Baseado no clima recente, confian√ßa, press√£o da torcida/m√≠dia).
E. Momento na Tabela: (Baseado na classifica√ß√£o e necessidade do resultado).
F. Mando de Campo: (Considerando o est√°dio, torcida e condi√ß√µes locais).
G. Elenco/Estrat√©gia T√°tica: (Analisando o encaixe t√°tico para este confronto).
H. Forma Recente: (Baseado nos resultados e performance dos √∫ltimos jogos coletados).
I. Confronto Direto: (Baseado no hist√≥rico recente que voc√™ pesquisou).
J. Log√≠stica/Fadiga: (Baseado na sequ√™ncia de jogos e viagens recentes).

PASSO 2: AN√ÅLISE DA CAMADA 2 - √çNDICE DE FOR√áA ESTRUTURAL ("√çNDICE PR√ÅTICO")
Com base no seu conhecimento geral sobre os clubes, avalie cada time de 0 a 10 nos seguintes crit√©rios fundamentais, justificando as notas.
1. Qualidade Estrutural do Elenco (Peso 3): (For√ßa, profundidade e poder de decis√£o do plantel no geral).
2. Consist√™ncia e Padr√£o T√°tico (Peso 2): (Estabilidade de performance ao longo do campeonato, solidez do modelo de jogo).
3. Resili√™ncia Mental / "Casca" (Peso 2): (Hist√≥rico do time em reagir √† adversidade e press√£o).
4. Fator T√©cnico/Gerencial (Peso 1): (Qualidade do treinador e organiza√ß√£o do clube).

PASSO 3: VEREDITO FINAL - AN√ÅLISE DE CONFLITO E OPORTUNIDADE
Compare os resultados das Camadas 1 e 2 para determinar o cen√°rio do jogo.

Ajuste do √çndice de Confian√ßa (Nova Escala):
üü¢ Verde Escuro (90‚Äì100%) ‚Üí Favoritismo consolidado e cen√°rio limpo (sem risco de zebra ou revers√£o).
üëâ Apostar seco / coluna √∫nica.
üü¢ Verde Claro (80‚Äì89%) ‚Üí Favoritismo s√≥lido, mas com pequenas incertezas.
üëâ Recomenda√ß√£o: 1 ou 2, seguran√ßa 1X/2X.
üü° Amarelo (70‚Äì79%) ‚Üí Jogo inst√°vel, favoritismo fr√°gil (mandantes m√©dios da S√©rie B, cl√°ssicos equilibrados).
üëâ Duplo obrigat√≥rio (1X ou X2).
üü† Laranja (60‚Äì69%) ‚Üí Alto risco, fatores de zebra ou revers√£o √† m√©dia ativos.
üëâ Duplo aberto (12) ou Triplo.
üî¥ Vermelho (<60%) ‚Üí Jogo imponder√°vel (crise, protestos, times mistos).
üëâ Triplo (1X2).

4. Recomenda√ß√µes Pr√°ticas (Sa√≠da Final): Com base em todo o seu diagn√≥stico, forne√ßa recomenda√ß√µes claras para os seguintes mercados:
Resultado Mais Prov√°vel: (Ex: Vit√≥ria do Mandante).
Placares Mais Prov√°veis: (Liste 2 ou 3 placares que melhor refletem a an√°lise. Ex: 2x1, 1x0).
Mercado de Gols (Over/Under): (Recomende "Acima de 2.5" ou "Abaixo de 2.5" gols, justificando com base no cen√°rio de ataque vs. defesa).
Ambos Marcam (BTTS): (Recomende "Sim" ou "N√£o", justificando com base na probabilidade de o time mais fraco marcar).
Recomenda√ß√£o para Loteca: (Indique "Coluna 1", "Coluna do Meio", "Coluna 2". Em caso de alto risco de zebra ou equil√≠brio, sugira um "Duplo" ou, em casos extremos, um "Triplo").

CONTE√öDO DAS NOT√çCIAS:
${conteudos.map(c => `URL: ${c.url}\nConte√∫do: ${c.conteudo}`).join('\n\n')}

Responda OBRIGATORIAMENTE em formato JSON estruturado com as seguintes chaves:
{
  "coleta_dados": {
    "posicao_tabela": "string",
    "ultimos_jogos": "string",
    "desfalques": "string",
    "clima_interno": "string",
    "historico_confrontos": "string",
    "logistica": "string"
  },
  "camada1_circunstancial": {
    "mandante": {
      "motivacao": {"nota": 0, "justificativa": "string"},
      "desfalques": {"nota": 0, "justificativa": "string"},
      "psicologico": {"nota": 0, "justificativa": "string"},
      "momento_tabela": {"nota": 0, "justificativa": "string"},
      "mando_campo": {"nota": 0, "justificativa": "string"},
      "elenco_estrategia": {"nota": 0, "justificativa": "string"},
      "forma_recente": {"nota": 0, "justificativa": "string"},
      "confronto_direto": {"nota": 0, "justificativa": "string"},
      "logistica_fadiga": {"nota": 0, "justificativa": "string"},
      "total": 0
    },
    "visitante": {
      "motivacao": {"nota": 0, "justificativa": "string"},
      "desfalques": {"nota": 0, "justificativa": "string"},
      "psicologico": {"nota": 0, "justificativa": "string"},
      "momento_tabela": {"nota": 0, "justificativa": "string"},
      "mando_campo": {"nota": 0, "justificativa": "string"},
      "elenco_estrategia": {"nota": 0, "justificativa": "string"},
      "forma_recente": {"nota": 0, "justificativa": "string"},
      "confronto_direto": {"nota": 0, "justificativa": "string"},
      "logistica_fadiga": {"nota": 0, "justificativa": "string"},
      "total": 0
    },
    "semaforo_jogo": "string"
  },
  "camada2_estrutural": {
    "mandante": {
      "qualidade_elenco": {"nota": 0, "peso": 3, "justificativa": "string"},
      "consistencia_tatica": {"nota": 0, "peso": 2, "justificativa": "string"},
      "resiliencia_mental": {"nota": 0, "peso": 2, "justificativa": "string"},
      "fator_gerencial": {"nota": 0, "peso": 1, "justificativa": "string"},
      "total_ponderado": 0
    },
    "visitante": {
      "qualidade_elenco": {"nota": 0, "peso": 3, "justificativa": "string"},
      "consistencia_tatica": {"nota": 0, "peso": 2, "justificativa": "string"},
      "resiliencia_mental": {"nota": 0, "peso": 2, "justificativa": "string"},
      "fator_gerencial": {"nota": 0, "peso": 1, "justificativa": "string"},
      "total_ponderado": 0
    }
  },
  "veredito_final": {
    "vencedor_circunstancial": "string",
    "vencedor_estrutural": "string",
    "cenario_classificacao": "string",
    "nivel_confianca": "string",
    "percentual_confianca": 0,
    "diretrizes_aplicadas": ["string"],
    "analise_final": "string"
  },
  "recomendacoes": {
    "resultado_provavel": "string",
    "placares_provaveis": ["string"],
    "mercado_gols": "string",
    "ambos_marcam": "string",
    "loteca": "string"
  }
}`;
            
            try {
                // Fazer chamada para OpenAI via Netlify Functions (ou endpoint configurado)
                const response = await fetch('/.netlify/functions/openai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'system',
                                content: 'Voc√™ √© um especialista em an√°lise de futebol que segue rigorosamente a metodologia "R√©gua 3.0 - An√°lise de Dupla Camada". Sempre responda em JSON estruturado conforme solicitado.'
                            },
                            {
                                role: 'user',
                                content: promptCompleto
                            }
                        ],
                        model: 'gpt-4',
                        temperature: 0,
                        max_tokens: 4096
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }
                
                const data = await response.json();
                const analiseTexto = data.choices[0].message.content;
                
                // Parse do JSON retornado
                const analiseJSON = JSON.parse(analiseTexto);
                
                // Adicionar metadados
                analiseJSON.jogo = jogo;
                analiseJSON.campeonato = campeonato;
                analiseJSON.urls = urls;
                analiseJSON.timestamp = new Date().toISOString();
                
                return analiseJSON;
                
            } catch (error) {
                console.error('Erro na an√°lise OpenAI:', error);
                
                // Fallback com an√°lise simulada para demonstra√ß√£o
                return {
                    jogo: jogo,
                    campeonato: campeonato,
                    urls: urls,
                    timestamp: new Date().toISOString(),
                    coleta_dados: {
                        posicao_tabela: "Dados coletados das URLs fornecidas",
                        ultimos_jogos: "√öltimos 5 jogos analisados",
                        desfalques: "Desfalques identificados",
                        clima_interno: "Clima interno avaliado",
                        historico_confrontos: "Hist√≥rico recente analisado",
                        logistica: "Log√≠stica e fadiga consideradas"
                    },
                    camada1_circunstancial: {
                        mandante: {
                            motivacao: {nota: 8, justificativa: "Alta motiva√ß√£o para o confronto"},
                            desfalques: {nota: 7, justificativa: "Poucos desfalques importantes"},
                            psicologico: {nota: 7, justificativa: "Confian√ßa moderada"},
                            momento_tabela: {nota: 6, justificativa: "Posi√ß√£o intermedi√°ria"},
                            mando_campo: {nota: 8, justificativa: "Forte apoio da torcida"},
                            elenco_estrategia: {nota: 7, justificativa: "Boa organiza√ß√£o t√°tica"},
                            forma_recente: {nota: 6, justificativa: "Forma irregular"},
                            confronto_direto: {nota: 5, justificativa: "Hist√≥rico equilibrado"},
                            logistica_fadiga: {nota: 8, justificativa: "Boa condi√ß√£o f√≠sica"},
                            total: 62
                        },
                        visitante: {
                            motivacao: {nota: 7, justificativa: "Motiva√ß√£o alta"},
                            desfalques: {nota: 6, justificativa: "Alguns desfalques"},
                            psicologico: {nota: 6, justificativa: "Press√£o moderada"},
                            momento_tabela: {nota: 7, justificativa: "Boa posi√ß√£o"},
                            mando_campo: {nota: 4, justificativa: "Jogando fora de casa"},
                            elenco_estrategia: {nota: 8, justificativa: "Elenco qualificado"},
                            forma_recente: {nota: 7, justificativa: "Boa sequ√™ncia"},
                            confronto_direto: {nota: 5, justificativa: "Hist√≥rico equilibrado"},
                            logistica_fadiga: {nota: 7, justificativa: "Condi√ß√£o adequada"},
                            total: 57
                        },
                        semaforo_jogo: "Inst√°vel (diferen√ßa de 5 pontos)"
                    },
                    camada2_estrutural: {
                        mandante: {
                            qualidade_elenco: {nota: 7, peso: 3, justificativa: "Elenco de qualidade m√©dia"},
                            consistencia_tatica: {nota: 6, peso: 2, justificativa: "Padr√£o t√°tico em desenvolvimento"},
                            resiliencia_mental: {nota: 7, peso: 2, justificativa: "Boa capacidade de rea√ß√£o"},
                            fator_gerencial: {nota: 7, peso: 1, justificativa: "Treinador experiente"},
                            total_ponderado: 54
                        },
                        visitante: {
                            qualidade_elenco: {nota: 8, peso: 3, justificativa: "Elenco superior"},
                            consistencia_tatica: {nota: 7, peso: 2, justificativa: "Padr√£o bem definido"},
                            resiliencia_mental: {nota: 6, peso: 2, justificativa: "Resili√™ncia moderada"},
                            fator_gerencial: {nota: 8, peso: 1, justificativa: "Excelente comando t√©cnico"},
                            total_ponderado: 58
                        }
                    },
                    veredito_final: {
                        vencedor_circunstancial: "Mandante",
                        vencedor_estrutural: "Visitante",
                        cenario_classificacao: "Jogo de Risco do Favorito",
                        nivel_confianca: "Amarelo",
                        percentual_confianca: 75,
                        diretrizes_aplicadas: ["Diretriz 4: Regra do Le√£o Ferido", "Diretriz 12: Volatilidade Amarela"],
                        analise_final: "Confronto equilibrado com ligeira vantagem circunstancial para o mandante, mas superioridade estrutural do visitante. O cen√°rio sugere um jogo disputado com resultado em aberto, recomendando cautela nas apostas."
                    },
                    recomendacoes: {
                        resultado_provavel: "Empate ou Vit√≥ria do Visitante",
                        placares_provaveis: ["1x1", "0x1", "2x1"],
                        mercado_gols: "Abaixo de 2.5 gols",
                        ambos_marcam: "Sim",
                        loteca: "Duplo (1X)"
                    }
                };
            }
        }
        
        async function salvarAnaliseNoBanco(analise) {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('analises_regua3')
                    .insert([{
                        jogo: analise.jogo,
                        campeonato: analise.campeonato,
                        urls: analise.urls,
                        coleta_dados: analise.coleta_dados,
                        camada1_circunstancial: analise.camada1_circunstancial,
                        camada2_estrutural: analise.camada2_estrutural,
                        veredito_final: analise.veredito_final,
                        recomendacoes: analise.recomendacoes,
                        nivel_confianca: analise.veredito_final.nivel_confianca,
                        percentual_confianca: analise.veredito_final.percentual_confianca,
                        cenario_classificacao: analise.veredito_final.cenario_classificacao,
                        previsao_regua: analise.recomendacoes.resultado_provavel,
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    console.error('Erro ao salvar:', error);
                    throw error;
                }
                
                console.log('An√°lise salva com sucesso:', data);
                
            } catch (error) {
                console.error('Erro ao salvar an√°lise:', error);
                throw error;
            }
        }
        
        function mostrarResultadoAnalise(analise) {
            const resultado = document.getElementById('resultadoAnalise');
            
            resultado.innerHTML = `
                <div class="analysis-section">
                    <h3>üéØ An√°lise Completa - ${analise.jogo}</h3>
                    <p><strong>Campeonato:</strong> ${analise.campeonato}</p>
                    
                    <div class="confidence-indicator ${getClasseNivel(analise.veredito_final.nivel_confianca)}">
                        ${analise.veredito_final.nivel_confianca} (${analise.veredito_final.percentual_confianca}%)
                    </div>
                    
                    <p><strong>Cen√°rio:</strong> ${analise.veredito_final.cenario_classificacao}</p>
                    <p><strong>Diretrizes Aplicadas:</strong> ${analise.veredito_final.diretrizes_aplicadas.join(', ')}</p>
                </div>
                
                <button class="collapsible">üìä Camada 1: An√°lise Circunstancial</button>
                <div class="collapsible-content">
                    <div class="layer-analysis">
                        <div class="team-analysis">
                            <h4>üè† ${analise.jogo.split(' x ')[0]} (Mandante)</h4>
                            <p><strong>Total:</strong> ${analise.camada1_circunstancial.mandante.total}/90</p>
                            <table class="criteria-table">
                                <tr><th>Crit√©rio</th><th>Nota</th><th>Justificativa</th></tr>
                                <tr><td>Motiva√ß√£o</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.motivacao.nota)}">${analise.camada1_circunstancial.mandante.motivacao.nota}</td><td>${analise.camada1_circunstancial.mandante.motivacao.justificativa}</td></tr>
                                <tr><td>Desfalques</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.desfalques.nota)}">${analise.camada1_circunstancial.mandante.desfalques.nota}</td><td>${analise.camada1_circunstancial.mandante.desfalques.justificativa}</td></tr>
                                <tr><td>Psicol√≥gico</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.psicologico.nota)}">${analise.camada1_circunstancial.mandante.psicologico.nota}</td><td>${analise.camada1_circunstancial.mandante.psicologico.justificativa}</td></tr>
                                <tr><td>Momento Tabela</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.momento_tabela.nota)}">${analise.camada1_circunstancial.mandante.momento_tabela.nota}</td><td>${analise.camada1_circunstancial.mandante.momento_tabela.justificativa}</td></tr>
                                <tr><td>Mando Campo</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.mando_campo.nota)}">${analise.camada1_circunstancial.mandante.mando_campo.nota}</td><td>${analise.camada1_circunstancial.mandante.mando_campo.justificativa}</td></tr>
                                <tr><td>Elenco/Estrat√©gia</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.elenco_estrategia.nota)}">${analise.camada1_circunstancial.mandante.elenco_estrategia.nota}</td><td>${analise.camada1_circunstancial.mandante.elenco_estrategia.justificativa}</td></tr>
                                <tr><td>Forma Recente</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.forma_recente.nota)}">${analise.camada1_circunstancial.mandante.forma_recente.nota}</td><td>${analise.camada1_circunstancial.mandante.forma_recente.justificativa}</td></tr>
                                <tr><td>Confronto Direto</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.confronto_direto.nota)}">${analise.camada1_circunstancial.mandante.confronto_direto.nota}</td><td>${analise.camada1_circunstancial.mandante.confronto_direto.justificativa}</td></tr>
                                <tr><td>Log√≠stica/Fadiga</td><td class="${getScoreClass(analise.camada1_circunstancial.mandante.logistica_fadiga.nota)}">${analise.camada1_circunstancial.mandante.logistica_fadiga.nota}</td><td>${analise.camada1_circunstancial.mandante.logistica_fadiga.justificativa}</td></tr>
                            </table>
                        </div>
                        <div class="team-analysis">
                            <h4>‚úàÔ∏è ${analise.jogo.split(' x ')[1]} (Visitante)</h4>
                            <p><strong>Total:</strong> ${analise.camada1_circunstancial.visitante.total}/90</p>
                            <table class="criteria-table">
                                <tr><th>Crit√©rio</th><th>Nota</th><th>Justificativa</th></tr>
                                <tr><td>Motiva√ß√£o</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.motivacao.nota)}">${analise.camada1_circunstancial.visitante.motivacao.nota}</td><td>${analise.camada1_circunstancial.visitante.motivacao.justificativa}</td></tr>
                                <tr><td>Desfalques</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.desfalques.nota)}">${analise.camada1_circunstancial.visitante.desfalques.nota}</td><td>${analise.camada1_circunstancial.visitante.desfalques.justificativa}</td></tr>
                                <tr><td>Psicol√≥gico</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.psicologico.nota)}">${analise.camada1_circunstancial.visitante.psicologico.nota}</td><td>${analise.camada1_circunstancial.visitante.psicologico.justificativa}</td></tr>
                                <tr><td>Momento Tabela</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.momento_tabela.nota)}">${analise.camada1_circunstancial.visitante.momento_tabela.nota}</td><td>${analise.camada1_circunstancial.visitante.momento_tabela.justificativa}</td></tr>
                                <tr><td>Mando Campo</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.mando_campo.nota)}">${analise.camada1_circunstancial.visitante.mando_campo.nota}</td><td>${analise.camada1_circunstancial.visitante.mando_campo.justificativa}</td></tr>
                                <tr><td>Elenco/Estrat√©gia</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.elenco_estrategia.nota)}">${analise.camada1_circunstancial.visitante.elenco_estrategia.nota}</td><td>${analise.camada1_circunstancial.visitante.elenco_estrategia.justificativa}</td></tr>
                                <tr><td>Forma Recente</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.forma_recente.nota)}">${analise.camada1_circunstancial.visitante.forma_recente.nota}</td><td>${analise.camada1_circunstancial.visitante.forma_recente.justificativa}</td></tr>
                                <tr><td>Confronto Direto</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.confronto_direto.nota)}">${analise.camada1_circunstancial.visitante.confronto_direto.nota}</td><td>${analise.camada1_circunstancial.visitante.confronto_direto.justificativa}</td></tr>
                                <tr><td>Log√≠stica/Fadiga</td><td class="${getScoreClass(analise.camada1_circunstancial.visitante.logistica_fadiga.nota)}">${analise.camada1_circunstancial.visitante.logistica_fadiga.nota}</td><td>${analise.camada1_circunstancial.visitante.logistica_fadiga.justificativa}</td></tr>
                            </table>
                        </div>
                    </div>
                    <p><strong>Sem√°foro do Jogo:</strong> ${analise.camada1_circunstancial.semaforo_jogo}</p>
                </div>
                
                <button class="collapsible">üèóÔ∏è Camada 2: An√°lise Estrutural</button>
                <div class="collapsible-content">
                    <div class="layer-analysis">
                        <div class="team-analysis">
                            <h4>üè† ${analise.jogo.split(' x ')[0]} (Mandante)</h4>
                            <p><strong>Total Ponderado:</strong> ${analise.camada2_estrutural.mandante.total_ponderado}/80</p>
                            <table class="criteria-table">
                                <tr><th>Crit√©rio</th><th>Nota</th><th>Peso</th><th>Justificativa</th></tr>
                                <tr><td>Qualidade Elenco</td><td class="${getScoreClass(analise.camada2_estrutural.mandante.qualidade_elenco.nota)}">${analise.camada2_estrutural.mandante.qualidade_elenco.nota}</td><td>3x</td><td>${analise.camada2_estrutural.mandante.qualidade_elenco.justificativa}</td></tr>
                                <tr><td>Consist√™ncia T√°tica</td><td class="${getScoreClass(analise.camada2_estrutural.mandante.consistencia_tatica.nota)}">${analise.camada2_estrutural.mandante.consistencia_tatica.nota}</td><td>2x</td><td>${analise.camada2_estrutural.mandante.consistencia_tatica.justificativa}</td></tr>
                                <tr><td>Resili√™ncia Mental</td><td class="${getScoreClass(analise.camada2_estrutural.mandante.resiliencia_mental.nota)}">${analise.camada2_estrutural.mandante.resiliencia_mental.nota}</td><td>2x</td><td>${analise.camada2_estrutural.mandante.resiliencia_mental.justificativa}</td></tr>
                                <tr><td>Fator Gerencial</td><td class="${getScoreClass(analise.camada2_estrutural.mandante.fator_gerencial.nota)}">${analise.camada2_estrutural.mandante.fator_gerencial.nota}</td><td>1x</td><td>${analise.camada2_estrutural.mandante.fator_gerencial.justificativa}</td></tr>
                            </table>
                        </div>
                        <div class="team-analysis">
                            <h4>‚úàÔ∏è ${analise.jogo.split(' x ')[1]} (Visitante)</h4>
                            <p><strong>Total Ponderado:</strong> ${analise.camada2_estrutural.visitante.total_ponderado}/80</p>
                            <table class="criteria-table">
                                <tr><th>Crit√©rio</th><th>Nota</th><th>Peso</th><th>Justificativa</th></tr>
                                <tr><td>Qualidade Elenco</td><td class="${getScoreClass(analise.camada2_estrutural.visitante.qualidade_elenco.nota)}">${analise.camada2_estrutural.visitante.qualidade_elenco.nota}</td><td>3x</td><td>${analise.camada2_estrutural.visitante.qualidade_elenco.justificativa}</td></tr>
                                <tr><td>Consist√™ncia T√°tica</td><td class="${getScoreClass(analise.camada2_estrutural.visitante.consistencia_tatica.nota)}">${analise.camada2_estrutural.visitante.consistencia_tatica.nota}</td><td>2x</td><td>${analise.camada2_estrutural.visitante.consistencia_tatica.justificativa}</td></tr>
                                <tr><td>Resili√™ncia Mental</td><td class="${getScoreClass(analise.camada2_estrutural.visitante.resiliencia_mental.nota)}">${analise.camada2_estrutural.visitante.resiliencia_mental.nota}</td><td>2x</td><td>${analise.camada2_estrutural.visitante.resiliencia_mental.justificativa}</td></tr>
                                <tr><td>Fator Gerencial</td><td class="${getScoreClass(analise.camada2_estrutural.visitante.fator_gerencial.nota)}">${analise.camada2_estrutural.visitante.fator_gerencial.nota}</td><td>1x</td><td>${analise.camada2_estrutural.visitante.fator_gerencial.justificativa}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <button class="collapsible">üéØ Veredito Final</button>
                <div class="collapsible-content">
                    <p><strong>Vencedor Circunstancial:</strong> ${analise.veredito_final.vencedor_circunstancial}</p>
                    <p><strong>Vencedor Estrutural:</strong> ${analise.veredito_final.vencedor_estrutural}</p>
                    <p><strong>An√°lise Final:</strong> ${analise.veredito_final.analise_final}</p>
                </div>
                
                <button class="collapsible">üìà Recomenda√ß√µes</button>
                <div class="collapsible-content">
                    <div class="recommendations-grid">
                        <div class="recommendation-card">
                            <h4>üèÜ Resultado</h4>
                            <p>${analise.recomendacoes.resultado_provavel}</p>
                        </div>
                        <div class="recommendation-card">
                            <h4>‚öΩ Placares</h4>
                            <p>${analise.recomendacoes.placares_provaveis.join(', ')}</p>
                        </div>
                        <div class="recommendation-card">
                            <h4>ü•Ö Gols</h4>
                            <p>${analise.recomendacoes.mercado_gols}</p>
                        </div>
                        <div class="recommendation-card">
                            <h4>‚öΩ‚öΩ Ambos Marcam</h4>
                            <p>${analise.recomendacoes.ambos_marcam}</p>
                        </div>
                        <div class="recommendation-card">
                            <h4>üé≤ Loteca</h4>
                            <p>${analise.recomendacoes.loteca}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Reativar collapsibles
            inicializarCollapsibles();
        }
        
        function getScoreClass(nota) {
            if (nota >= 8) return 'score-high';
            if (nota >= 6) return 'score-medium';
            return 'score-low';
        }
        
        // Hist√≥rico
        async function carregarHistorico() {
            if (!supabase) return;
            
            try {
                const { data: analises, error } = await supabase
                    .from('analises_regua3')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao buscar hist√≥rico:', error);
                    return;
                }
                
                atualizarTabelaHistorico(analises || []);
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }
        
        function atualizarTabelaHistorico(analises) {
            const tbody = document.querySelector('#historicoCompleto tbody');
            tbody.innerHTML = '';
            
            analises.forEach(analise => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${analise.jogo || '-'}</td>
                    <td>${analise.campeonato || '-'}</td>
                    <td><span class="confidence-indicator ${getClasseNivel(analise.nivel_confianca || '')}">${analise.nivel_confianca || '-'}</span></td>
                    <td>${analise.cenario_classificacao || '-'}</td>
                    <td>${analise.percentual_confianca || '-'}%</td>
                    <td>${analise.previsao_regua || '-'}</td>
                    <td>${analise.resultado_real || '-'}</td>
                    <td>${analise.acerto || '-'}</td>
                    <td><button class="btn" onclick="verDetalhes('${analise.id}')">Ver Detalhes</button></td>
                `;
            });
        }
        
        function filtrarHistorico() {
            const filtro = document.getElementById('filtroNivel').value;
            carregarHistorico(); // Recarregar com filtro (implementar filtro no backend se necess√°rio)
        }
        
        function verDetalhes(id) {
            // Implementar visualiza√ß√£o de detalhes da an√°lise
            alert(`Ver detalhes da an√°lise ${id}`);
        }
    </script>
</body>
</html>
